{% extends "base.html" %}

{% block title %}Pagos Recibidos{% endblock %}

{% block content %}
<style>
    .pagos-header {
        background: linear-gradient(135deg, #1a237e 0%, #0d47a1 100%);
        color: white;
        border-radius: 15px;
        padding: 2rem 2rem 1rem 2rem;
        margin-bottom: 2rem;
        box-shadow: 0 4px 15px rgba(0,0,0,0.08);
        display: flex;
        align-items: center;
        justify-content: space-between;
    }
    .pagos-header h2 {
        font-size: 2rem;
        font-weight: 700;
        margin: 0;
        display: flex;
        align-items: center;
    }
    .pagos-header i {
        font-size: 2.2rem;
        margin-right: 1rem;
    }
    .stats-card {
        background: white;
        border-radius: 15px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.05);
        border: none;
        margin-bottom: 2rem;
        transition: all 0.3s ease;
        overflow: hidden;
    }
    .stats-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 8px 25px rgba(0,0,0,0.1);
    }
    .stats-card .card-body {
        padding: 1.5rem;
    }
    .stats-card .stats-value {
        font-size: 2rem;
        font-weight: 700;
        margin-bottom: 0.5rem;
    }
    .stats-card .stats-label {
        font-size: 1.1rem;
        font-weight: 600;
        opacity: 0.9;
    }
    .table thead th {
        background: #f8f9fa;
        font-weight: 700;
        color: #1a237e;
        border-top: none;
    }
    .table tbody tr {
        transition: all 0.2s;
    }
    .table tbody tr:hover {
        background: #e3f2fd;
        transform: scale(1.01);
        box-shadow: 0 2px 8px rgba(13,71,161,0.07);
    }
    .btn-action {
        padding: 0.5rem 1rem;
        font-size: 0.9rem;
        border-radius: 8px;
        margin-right: 0.2rem;
        transition: all 0.2s ease;
    }
    
    .btn-action:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }
    
    .badge-metodo {
        font-weight: 600;
        border-radius: 20px;
        transition: all 0.2s ease;
    }
    
    .badge-metodo:hover {
        transform: scale(1.05);
    }
    
    .badge-transferencia {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
    }
    
    .badge-efectivo {
        background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        color: white;
    }
    
    .badge-zelle {
        background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        color: white;
    }
    
    .badge-pago_movil {
        background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
        color: white;
    }
    
    .badge-divisas {
        background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
        color: white;
    }
    
    .badge-otro {
        background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);
        color: #333;
    }
    
    .floating-calc-btn {
        position: fixed;
        bottom: 32px;
        right: 32px;
        z-index: 1200;
        background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
        color: #fff;
        border: none;
        border-radius: 50%;
        width: 70px;
        height: 70px;
        box-shadow: 0 6px 20px rgba(67,233,123,0.25);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 2.2rem;
        transition: all 0.3s ease;
        cursor: pointer;
    }
    
    .floating-calc-btn:hover {
        box-shadow: 0 10px 30px rgba(67,233,123,0.35);
        transform: scale(1.1) rotate(5deg);
        color: #fff;
    }
    
    .floating-calc-btn:active {
        transform: scale(0.95);
    }
    /* Estilos para la Calculadora */
    .modal-calc .modal-content {
        border-radius: 20px;
        overflow: hidden;
    }
    
    .calc-pattern {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-image: 
            radial-gradient(circle at 20% 80%, rgba(255,255,255,0.1) 0%, transparent 50%),
            radial-gradient(circle at 80% 20%, rgba(255,255,255,0.1) 0%, transparent 50%),
            radial-gradient(circle at 40% 40%, rgba(255,255,255,0.05) 0%, transparent 50%);
        pointer-events: none;
    }
    
    .z-1 {
        z-index: 1;
    }
    
    .calc-input-section {
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        padding: 2rem;
        border-radius: 15px;
        border: 1px solid #dee2e6;
    }
    
    .calc-input-card {
        background: white;
        padding: 1.5rem;
        border-radius: 12px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        border: 1px solid #e9ecef;
        transition: all 0.3s ease;
    }
    
    .calc-input-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 20px rgba(0,0,0,0.1);
    }
    
    .calc-input-card .form-label {
        color: #495057;
        font-size: 1rem;
    }
    
    .calc-input-card .input-group-text {
        font-size: 1.1rem;
        padding: 0.75rem 1rem;
    }
    
    .calc-input-card .form-control,
    .calc-input-card .form-select {
        font-size: 1.1rem;
        padding: 0.75rem 1rem;
        border-radius: 0 8px 8px 0;
    }
    
    .calc-rates-section {
        background: white;
        padding: 1.5rem;
        border-radius: 15px;
        border: 1px solid #e9ecef;
        box-shadow: 0 2px 10px rgba(0,0,0,0.05);
    }
    
    .calc-rates-section h6 {
        color: #6c757d;
        font-size: 0.9rem;
        letter-spacing: 1px;
    }
    
    .rate-card {
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        padding: 1.5rem;
        border-radius: 12px;
        border: 1px solid #dee2e6;
        transition: all 0.3s ease;
    }
    
    .rate-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }
    
    .rate-header {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        margin-bottom: 1rem;
    }
    
    .rate-header i {
        font-size: 1.5rem;
    }
    
    .rate-label {
        font-weight: 600;
        color: #495057;
        font-size: 1rem;
    }
    
    .rate-value .form-control {
        font-size: 1.2rem;
        font-weight: 600;
        text-align: center;
        padding: 0.75rem;
        border-radius: 8px;
        box-shadow: inset 0 2px 4px rgba(0,0,0,0.05);
    }
    
    .calc-results-section {
        background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%);
        padding: 1.5rem;
        border-radius: 15px;
        border: 1px solid #ffeaa7;
    }
    
    .results-card {
        background: white;
        border-radius: 12px;
        overflow: hidden;
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }
    
    .results-header {
        background: linear-gradient(135deg, #ffc107 0%, #ffb300 100%);
        color: white;
        padding: 1rem 1.5rem;
        font-weight: 600;
        font-size: 1.1rem;
        display: flex;
        align-items: center;
        justify-content: space-between;
    }
    
    .results-status .badge {
        font-size: 0.8rem;
        padding: 0.5rem 0.75rem;
        border-radius: 20px;
        font-weight: 500;
    }
    
    .results-content {
        padding: 1.5rem;
        background: white;
    }
    
    .results-title {
        font-weight: 600;
    }
    
    /* Estilos para los resultados de conversión */
    .conversion-result {
        background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
        border: 1px solid #90caf9;
        border-radius: 10px;
        padding: 1rem;
        margin: 0.5rem 0;
        text-align: center;
        transition: all 0.3s ease;
    }
    
    .conversion-result:hover {
        transform: scale(1.02);
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }
    
    .conversion-result .currency-label {
        font-weight: 600;
        color: #1976d2;
        font-size: 0.9rem;
        text-transform: uppercase;
        letter-spacing: 1px;
    }
    
    .conversion-result .currency-value {
        font-size: 1.5rem;
        font-weight: 700;
        color: #1565c0;
        margin: 0.5rem 0;
    }
    
    .conversion-result .currency-symbol {
        font-size: 1.2rem;
        color: #1976d2;
        margin-right: 0.5rem;
    }
    
    /* Responsividad y mejoras adicionales */
    @media (max-width: 768px) {
        .modal-calc .modal-dialog {
            margin: 1rem;
        }
        
        .calc-input-section {
            padding: 1rem;
        }
        
        .calc-input-card {
            padding: 1rem;
        }
        
        .rate-card {
            padding: 1rem;
        }
        
        .conversion-result {
            margin: 0.25rem 0;
        }
        
        .conversion-result .currency-value {
            font-size: 1.2rem;
        }
    }
    
    /* Animaciones de entrada */
    .modal-calc .modal-content {
        animation: slideInUp 0.3s ease-out;
    }
    
    @keyframes slideInUp {
        from {
            opacity: 0;
            transform: translateY(30px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
    
    /* Efectos de hover mejorados */
    .calc-input-card:hover .input-group-text {
        transform: scale(1.05);
        transition: transform 0.2s ease;
    }
    
    .rate-card:hover .rate-header i {
        transform: rotate(5deg);
        transition: transform 0.3s ease;
    }
    
    /* Estilos para el botón de actualizar */
    .btn-primary {
        background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
        border: none;
        transition: all 0.3s ease;
    }
    
    .btn-primary:hover {
        background: linear-gradient(135deg, #0056b3 0%, #004085 100%);
        transform: translateY(-2px);
        box-shadow: 0 4px 15px rgba(0, 123, 255, 0.3);
    }
    
    /* Mejoras en los inputs */
    .form-control:focus,
    .form-select:focus {
        box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
        border-color: #007bff;
    }
    
    /* Estilos para el placeholder */
    .form-control::placeholder {
        color: #adb5bd;
        font-style: italic;
    }
    
    /* Estilos para las notificaciones de la calculadora */
    .alert {
        border-radius: 12px;
        border: none;
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        animation: slideInRight 0.3s ease-out;
    }
    
    @keyframes slideInRight {
        from {
            opacity: 0;
            transform: translateX(30px);
        }
        to {
            opacity: 1;
            transform: translateX(0);
        }
    }
    
    /* Mejoras en los botones del footer */
    .modal-footer .btn {
        border-radius: 10px;
        font-weight: 600;
        padding: 0.75rem 1.5rem;
        transition: all 0.3s ease;
    }
    
    .modal-footer .btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 15px rgba(0,0,0,0.2);
    }
    
    /* Mejoras en los inputs de la calculadora */
    .calc-input-card .form-control:focus,
    .calc-input-card .form-select:focus {
        box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
        border-color: #007bff;
        transform: scale(1.02);
        transition: all 0.2s ease;
    }
    
    /* Efectos de hover en las tarjetas de tasa */
    .rate-card:hover .rate-value .form-control {
        box-shadow: inset 0 2px 8px rgba(0,0,0,0.1);
        transform: scale(1.02);
        transition: all 0.2s ease;
    }
    
    /* Estilos para números con separadores de miles */
    .currency-value {
        font-family: 'Courier New', monospace;
        font-weight: 700;
        letter-spacing: 0.5px;
    }
    
    .currency-symbol {
        color: #6c757d;
        font-weight: 600;
        margin-right: 2px;
    }
    
    /* Mejoras en los campos de entrada con separadores */
    .calc-input-card .form-control,
    .rate-card .form-control {
        font-family: 'Courier New', monospace;
        font-weight: 600;
        text-align: right;
        padding-right: 15px;
    }
    
    /* Indicador visual para campos con separadores */
    .calc-input-card .form-control:not(:focus):not(:placeholder-shown),
    .rate-card .form-control:not(:focus):not(:placeholder-shown) {
        background-color: #f8f9fa;
        border-color: #dee2e6;
    }
    
    /* Estilos para el botón de cargar tasas */
    .calc-rates-section .btn-outline-primary {
        font-size: 0.8rem;
        padding: 0.25rem 0.5rem;
        border-radius: 6px;
        transition: all 0.2s ease;
    }
    
    .calc-rates-section .btn-outline-primary:hover {
        transform: translateY(-1px);
        box-shadow: 0 2px 8px rgba(0, 123, 255, 0.3);
    }
    
    /* Mejoras en la sección de tasas */
    .calc-rates-section .text-center {
        border-top: 1px solid #e9ecef;
        padding-top: 0.75rem;
        margin-top: 0.5rem;
    }
    
    .detail-item {
        transition: all 0.2s ease;
        border: 1px solid #e9ecef;
    }
    
    .detail-item:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        border-color: #dee2e6;
    }
    
    .detail-label {
        font-size: 0.85rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    
    .detail-value {
        font-size: 1.1rem;
        color: #495057;
    }
    
    .bg-gradient-primary {
        background: linear-gradient(135deg, #1a237e 0%, #0d47a1 100%);
    }
    
    .bg-gradient-success {
        background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
    }
    
    .filtros-avanzados .card {
        border: none;
        box-shadow: 0 2px 10px rgba(0,0,0,0.08);
        transition: all 0.3s ease;
    }
    
    .filtros-avanzados .card:hover {
        box-shadow: 0 4px 20px rgba(0,0,0,0.12);
    }
    
    .table-tools {
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        border: 1px solid #dee2e6;
    }
    
    .table-tools .form-control,
    .table-tools .form-select {
        border: 1px solid #ced4da;
        transition: all 0.2s ease;
    }
    
    .table-tools .form-control:focus,
    .table-tools .form-select:focus {
        border-color: #1a237e;
        box-shadow: 0 0 0 0.2rem rgba(26, 35, 126, 0.25);
    }
    /* Tabla moderna */
    .table-modern thead th {
        background: #1a237e;
        color: #fff;
        position: sticky;
        top: 0;
        z-index: 2;
        border-top: none;
        cursor: default;
    }
    .table-modern tbody tr:nth-child(even) {
        background: #f4f8fb;
    }
    .table-modern tbody tr:hover {
        background: #e3f2fd;
        transform: scale(1.01);
        box-shadow: 0 2px 8px rgba(13,71,161,0.07);
    }
    .badge-metodo {
        font-size: 0.95em;
        border-radius: 8px;
        padding: 0.3em 0.8em;
        font-weight: 600;
    }
    .badge-transferencia { background: #e1bee7; color: #6a1b9a; }
    .badge-efectivo { background: #ffe082; color: #bfa43a; }
    .badge-zelle { background: #b2dfdb; color: #00695c; }
    .badge-pago_movil { background: #bbdefb; color: #1565c0; }
    .badge-divisas { background: #c8e6c9; color: #388e3c; }
    .badge-otro { background: #f8bbd0; color: #ad1457; }
    .btn-action {
        padding: 0.4rem 0.7rem;
        font-size: 1rem;
        border-radius: 8px;
        margin-right: 0.2rem;
    }

    /* Alineación numérica y anchos por columna */
    .col-factura { width: 10rem; }
    .col-fecha { width: 9.5rem; }
    .col-cliente { min-width: 16rem; }
    .col-metodo { width: 8.5rem; }
    .col-monto { width: 9rem; }
    .numeric { text-align: right; font-variant-numeric: tabular-nums; white-space: nowrap; }
    .hidden-col { display: none !important; }

    /* Barra de herramientas de tabla */
    .table-tools { display:flex; gap:.5rem; align-items:center; flex-wrap: wrap; margin-bottom:.75rem; }
    .table-tools .form-control, .table-tools .form-select { height: 36px; }
    .table-tools .btn { height: 36px; }

    /* Encabezados ordenables */
    th.sortable { cursor: pointer; user-select: none; position: relative; }
    th.sortable::after {
        content: '\25B4\25BE'; /* ▲▼ */
        font-size: .7rem; opacity: .6; margin-left: .35rem;
    }
    th.sortable.asc::after { content: '\25B4'; opacity: 1; }
    th.sortable.desc::after { content: '\25BE'; opacity: 1; }

    /* Validador Pago Móvil */
    .validator-hint { font-size: .9rem; }
    .is-valid-pm { border-color: #28a745 !important; }
    .is-invalid-pm { border-color: #dc3545 !important; }

    /* Estilos de impresión: simplificar y optimizar lectura */
    @media print {
        .pagos-header, .floating-calc-btn, .table-tools, .btn, .card-header, nav, header, footer { display: none !important; }
        .card, .card-body { box-shadow: none !important; border: none !important; }
        .table-modern thead th { position: static; background: #f0f3f7 !important; color: #111 !important; }
        .table-modern tbody tr:hover { background: transparent; transform: none; box-shadow: none; }
        .table td, .table th { padding: 6px 8px !important; font-size: 11pt; }
        .numeric { font-size: 10.8pt; }
        .badge { border: 1px solid #999; }
        .table-modern { page-break-inside: auto; }
        .table-modern tr { page-break-inside: avoid; page-break-after: auto; }
        .table-modern thead { display: table-header-group; }
        .table-modern tfoot { display: table-footer-group; }
    }
</style>
<div class="container-fluid">
    <div class="pagos-header mb-4">
        <h2><i class="fas fa-cash-register"></i> Pagos Recibidos</h2>
        <div class="btn-group">
            <a href="/" class="btn btn-secondary">
                <i class="fas fa-arrow-left me-2"></i>Volver al Inicio
            </a>
        </div>
    </div>
    <div class="row mb-4">
        <div class="col-md-4">
            <div class="stats-card shadow-lg" style="background: linear-gradient(135deg, #e0f7fa 0%, #b2ebf2 100%); border: none;">
                <div class="card-body d-flex align-items-center">
                    <i class="fas fa-dollar-sign fa-2x me-3 text-success"></i>
                    <div>
                        <div class="stats-value text-success" style="font-size:2.1rem;">${{ total_usd|float|es_number }}</div>
                        <div class="stats-label">Total Pagos Recibidos (USD)</div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="stats-card shadow-lg" style="background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%); border: none;">
                <div class="card-body d-flex align-items-center">
                    <i class="fas fa-money-bill-wave fa-2x me-3 text-info"></i>
                    <div>
                        <div class="stats-value text-info" style="font-size:2.1rem;">{{ total_bs|float|es_number }} Bs</div>
                        <div class="stats-label">Total Pagos Recibidos (Bs)</div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="stats-card shadow-lg" style="background: linear-gradient(135deg, #fffde7 0%, #ffe082 100%); border: none;">
                <div class="card-body d-flex align-items-center">
                    <i class="fas fa-chart-line fa-2x me-3 text-warning"></i>
                    <div style="width:100%">
                        <!-- Carrusel de tasas -->
                        <div id="tasasCarousel" class="carousel slide" data-bs-ride="carousel" data-bs-interval="3000">
                          <div class="carousel-inner">
                            <div class="carousel-item active">
                              <div class="stats-value text-secondary" style="font-size:2.1rem;">
                                <span id="tasa-bcv-valor">{{ tasa_bcv|default('Cargando...', true)|es_number }}</span> <span class="badge bg-warning text-dark">BCV</span>
                              </div>
                            </div>
                            <div class="carousel-item">
                              <div class="stats-value text-secondary" style="font-size:2.1rem;">
                                <span id="tasa-eur-valor">{{ tasa_bcv_eur|default('Cargando...', true)|es_number }}</span> <span class="badge bg-primary">Euro</span>
                              </div>
                            </div>
                          </div>
                        </div>
                        <small class="d-block text-muted" style="font-size:0.8rem;" id="ultima-actualizacion">
                            <i class="fas fa-sync-alt fa-spin"></i> Actualizando...
                        </small>
                        <div class="stats-label">Tasa BCV Actual</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- Filtros Avanzados -->
    <div class="filtros-avanzados mb-4">
        <div class="card border-0 shadow-sm">
            <div class="card-header bg-light border-0 py-3">
                <h5 class="mb-0 text-primary fw-bold">
                    <i class="fas fa-filter me-2"></i>Filtros Avanzados
                </h5>
            </div>
            <div class="card-body">
                <form method="get" class="row g-3 align-items-end">
                    <div class="col-md-2">
                        <label for="mes" class="form-label fw-semibold text-muted">
                            <i class="fas fa-calendar-alt me-1"></i>Mes
                        </label>
                        <select name="mes" id="mes" class="form-select form-select-sm border-0 bg-light" onchange="this.form.submit()">
                            <option value="">Todos los meses</option>
                            {% for m in range(1, 13) %}
                                <option value="{{ m }}" {% if mes_seleccionado == m %}selected{% endif %}>
                                    {{ '{:02d}'.format(m) }} - {{ ['Ene', 'Feb', 'Mar', 'Abr', 'May', 'Jun', 'Jul', 'Ago', 'Sep', 'Oct', 'Nov', 'Dic'][m-1] }}
                                </option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label for="anio" class="form-label fw-semibold text-muted">
                            <i class="fas fa-calendar me-1"></i>Año
                        </label>
                        <select name="anio" id="anio" class="form-select form-select-sm border-0 bg-light" onchange="this.form.submit()">
                            <option value="">Todos los años</option>
                            {% for a in anios_disponibles %}
                                <option value="{{ a }}" {% if anio_seleccionado == a %}selected{% endif %}>{{ a }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-2">
                        <button type="submit" class="btn btn-primary btn-sm w-100">
                            <i class="fas fa-search me-1"></i>Filtrar
                        </button>
                    </div>
                    <div class="col-md-2">
                        <a href="{{ url_for('mostrar_pagos_recibidos') }}" class="btn btn-outline-secondary btn-sm w-100">
                            <i class="fas fa-undo me-1"></i>Limpiar
                        </a>
                    </div>
                </form>
            </div>
        </div>
    </div>
    <!-- Botón flotante para calculadora -->
    <button class="floating-calc-btn" id="openCalcModal" title="Calculadora de Montos">
        <i class="fas fa-calculator"></i>
    </button>

    <div class="card">
        <div class="card-header">
            <h4 class="mb-0">Detalle de Pagos Recibidos</h4>
        </div>
        <div class="card-body">
            <div class="table-tools bg-light p-3 rounded-3 mb-3">
                <div class="row g-3 align-items-center">
                    <!-- Primera fila: Búsqueda y filtros principales -->
                    <div class="col-lg-4 col-md-6">
                        <div class="input-group shadow-sm">
                            <span class="input-group-text bg-white border-end-0">
                                <i class="fas fa-search text-muted"></i>
                            </span>
                            <input id="filtroTexto" type="text" class="form-control border-start-0" 
                                   placeholder="Buscar factura, cliente, referencia...">
                        </div>
                    </div>
                    
                    <div class="col-lg-2 col-md-6">
                        <select id="filtroMetodo" class="form-select border-0 bg-white shadow-sm">
                            <option value="">Todos los métodos</option>
                            <option value="transferencia">Transferencia</option>
                            <option value="efectivo">Efectivo</option>
                            <option value="zelle">Zelle</option>
                            <option value="pago_movil">Pago Móvil</option>
                            <option value="divisas">Divisas</option>
                            <option value="otro">Otro</option>
                        </select>
                    </div>
                    
                    <div class="col-lg-3 col-md-6">
                        <div class="input-group shadow-sm">
                            <span class="input-group-text bg-white border-end-0">
                                <i class="fas fa-calendar-alt text-muted"></i>
                            </span>
                            <input type="date" id="fechaDesde" class="form-control border-start-0" title="Desde">
                            <span class="input-group-text bg-white border-0 text-muted">-</span>
                            <input type="date" id="fechaHasta" class="form-control border-start-0" title="Hasta">
                        </div>
                    </div>
                    
                    <div class="col-lg-3 col-md-6">
                        <div class="d-flex gap-2 flex-wrap">
                            <button id="exportCsv" class="btn btn-success btn-sm shadow-sm">
                                <i class="fas fa-file-csv me-1"></i>Exportar CSV
                            </button>
                            <button id="limpiarFiltros" class="btn btn-warning btn-sm shadow-sm">
                                <i class="fas fa-eraser me-1"></i>Limpiar
                            </button>
                            <button id="imprimirListado" class="btn btn-info btn-sm shadow-sm">
                                <i class="fas fa-print me-1"></i>Imprimir
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Segunda fila: Controles de paginación y columnas -->
                <div class="row g-3 align-items-center mt-3 pt-3 border-top">
                    <div class="col-lg-2 col-md-4">
                        <div class="input-group shadow-sm">
                            <span class="input-group-text bg-white border-end-0">
                                <i class="fas fa-list-ol text-muted"></i>
                            </span>
                            <select id="pageSize" class="form-select border-start-0 bg-white">
                                <option value="10">10 por página</option>
                                <option value="25">25 por página</option>
                                <option value="50">50 por página</option>
                                <option value="100">100 por página</option>
                                <option value="0">Todos</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="col-lg-3 col-md-4">
                        <div id="paginacion" class="d-flex align-items-center gap-2">
                            <button id="prevPage" class="btn btn-outline-primary btn-sm">
                                <i class="fas fa-chevron-left"></i>
                            </button>
                            <span id="pageInfo" class="badge bg-primary px-3 py-2">1 / 1</span>
                            <button id="nextPage" class="btn btn-outline-primary btn-sm">
                                <i class="fas fa-chevron-right"></i>
                            </button>
                        </div>
                    </div>
                    
                    <div class="col-lg-7 col-md-4">
                        <div class="d-flex align-items-center gap-3 flex-wrap">
                            <span class="text-muted fw-semibold">Columnas:</span>
                            <div class="form-check form-check-inline m-0">
                                <input class="form-check-input col-toggle" type="checkbox" data-col="metodo" checked id="col-metodo">
                                <label class="form-check-label" for="col-metodo">Método</label>
                            </div>
                            <div class="form-check form-check-inline m-0">
                                <input class="form-check-input col-toggle" type="checkbox" data-col="usd" checked id="col-usd">
                                <label class="form-check-label" for="col-usd">USD</label>
                            </div>
                            <div class="form-check form-check-inline m-0">
                                <input class="form-check-input col-toggle" type="checkbox" data-col="bs" checked id="col-bs">
                                <label class="form-check-label" for="col-bs">Bs</label>
                            </div>
                            <div class="form-check form-check-inline m-0">
                                <input class="form-check-input col-toggle" type="checkbox" data-col="acciones" checked id="col-acciones">
                                <label class="form-check-label" for="col-acciones">Acciones</label>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="table-responsive">
                <table class="table table-hover align-middle table-modern" id="tablaPagos">
                    <thead>
                        <tr class="table-primary">
                            <th class="col-factura sortable border-0" data-key="factura" title="Ordenar">
                                <i class="fas fa-file-invoice me-1"></i>Factura
                            </th>
                            <th class="col-fecha sortable border-0" data-key="fecha" title="Ordenar">
                                <i class="fas fa-calendar me-1"></i>Fecha
                            </th>
                            <th class="col-cliente sortable border-0" data-key="cliente" title="Ordenar">
                                <i class="fas fa-user me-1"></i>Cliente
                            </th>
                            <th class="col-metodo sortable border-0" data-key="metodo" title="Ordenar">
                                <i class="fas fa-credit-card me-1"></i>Método
                            </th>
                            <th class="col-monto col-usd text-end sortable border-0" data-key="usd" title="Ordenar">
                                <i class="fas fa-dollar-sign me-1"></i>Monto (USD)
                            </th>
                            <th class="col-monto col-bs text-end sortable border-0" data-key="bs" title="Ordenar">
                                <i class="fas fa-money-bill-wave me-1"></i>Monto (Bs)
                            </th>
                            <th class="col-acciones border-0">
                                <i class="fas fa-cogs me-1"></i>Acciones
                            </th>
                        </tr>
                    </thead>
                    <tbody>
                        {% set tot = namespace(usd=0.0, bs=0.0) %}
                        {% for pago in pagos %}
                        {% set usd_val = pago.monto|float %}
                        {% set bs_val = (pago.monto|float * pago.tasa_bcv)|float %}
                        {% set tot.usd = tot.usd + usd_val %}
                        {% set tot.bs = tot.bs + bs_val %}
                        <tr data-metodo="{{ pago.metodo|replace(' ', '_')|lower }}"
                            data-factura="{{ pago.factura_id }}"
                            data-fecha="{{ pago.fecha }}"
                            data-cliente="{{ (clientes[pago.cliente_id].nombre if pago.cliente_id in clientes else pago.cliente_id)|lower }}"
                            data-referencia="{{ pago.referencia if pago.referencia is defined and pago.referencia else '' }}"
                            data-usd="{{ '%.2f' % usd_val }}"
                            data-bs="{{ '%.2f' % bs_val }}">
                            <td class="col-factura">
                                {% if pago.factura_id %}
                                    <a href="/facturas/{{ pago.factura_id }}">#{{ pago.factura_id }}</a>
                                {% else %}
                                    <span class="text-muted">Sin factura</span>
                                {% endif %}
                            </td>
                            <td class="col-fecha">{{ pago.fecha }}</td>
                            <td class="col-cliente">
                                {% if pago.cliente_id in clientes %}
                                    <a href="/clientes/{{ pago.cliente_id }}">{{ clientes[pago.cliente_id].nombre }}</a>
                                {% else %}
                                    {{ pago.cliente_id }}
                                {% endif %}
                            </td>
                            <td class="col-metodo">
                                <span class="badge badge-metodo badge-{{ pago.metodo|replace(' ', '_')|lower }} fs-6 px-3 py-2">
                                    <i class="fas fa-{{ 'credit-card' if pago.metodo == 'transferencia' else 'money-bill' if pago.metodo == 'efectivo' else 'university' if pago.metodo == 'zelle' else 'mobile-alt' if pago.metodo == 'pago_movil' else 'coins' if pago.metodo == 'divisas' else 'ellipsis-h' }} me-1"></i>
                                    {{ pago.metodo.replace('_', ' ').title() }}
                                </span>
                            </td>
                            <td class="numeric col-usd">$ {{ usd_val|es_number }}</td>
                            <td class="numeric col-bs">{{ bs_val|es_number }} Bs</td>
                            <td class="col-acciones">
                                <button class="btn btn-primary btn-action shadow-sm" data-bs-toggle="modal" data-bs-target="#modalDetallePago" 
                                    data-factura="{{ pago.factura_id }}" data-fecha="{{ pago.fecha }}" data-monto="{{ pago.monto }}" 
                                    data-metodo="{{ pago.metodo }}" 
                                    data-referencia="{{ pago.referencia if pago.referencia is defined and pago.referencia else '-' }}" 
                                    data-banco="{{ pago.banco if pago.banco is defined and pago.banco else '-' }}" 
                                    data-captura="{{ pago.captura_path|default('') }}" title="Ver Detalle">
                                    <i class="fas fa-eye me-1"></i>Ver
                                </button>
                            </td>
                        </tr>
                        {% endfor %}
                        {% if pagos|length == 0 %}
                        <tr>
                            <td colspan="7">No hay pagos registrados.</td>
                        </tr>
                        {% endif %}
                    </tbody>
                    <tfoot>
                        <tr class="table-info">
                            <th colspan="4" class="text-end border-0">
                                <i class="fas fa-calculator me-2"></i>Total listado:
                            </th>
                            <th class="numeric col-usd border-0 fw-bold fs-5" id="totalListadoUSD">
                                $ {{ tot.usd|es_number }}
                            </th>
                            <th class="numeric col-bs border-0 fw-bold fs-5" id="totalListadoBS">
                                {{ tot.bs|es_number }} Bs
                            </th>
                            <th class="border-0"></th>
                        </tr>
                        <tr>
                            <td colspan="7" class="border-0 bg-light">
                                <div id="resumenMetodos" class="d-flex flex-wrap gap-3 p-2">
                                    <span class="text-muted fw-semibold">
                                        <i class="fas fa-chart-pie me-1"></i>Resumen por método:
                                    </span>
                                </div>
                            </td>
                        </tr>
                    </tfoot>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Modal Detalle de Pago -->
<div class="modal fade" id="modalDetallePago" tabindex="-1" aria-labelledby="modalDetallePagoLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content border-0 shadow-lg">
      <div class="modal-header bg-gradient-primary text-white border-0">
        <h5 class="modal-title fw-bold" id="modalDetallePagoLabel">
          <i class="fas fa-eye me-2"></i>Detalle del Pago
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Cerrar"></button>
      </div>
      <div class="modal-body p-4">
        <div class="row g-3">
          <div class="col-md-6">
            <div class="detail-item bg-light p-3 rounded">
              <div class="detail-label text-muted fw-semibold mb-1">
                <i class="fas fa-file-invoice me-2"></i>Factura
              </div>
              <div class="detail-value fw-bold" id="detalle-factura">-</div>
            </div>
          </div>
          <div class="col-md-6">
            <div class="detail-item bg-light p-3 rounded">
              <div class="detail-label text-muted fw-semibold mb-1">
                <i class="fas fa-calendar me-2"></i>Fecha
              </div>
              <div class="detail-value fw-bold" id="detalle-fecha">-</div>
            </div>
          </div>
          <div class="col-md-6">
            <div class="detail-item bg-light p-3 rounded">
              <div class="detail-label text-muted fw-semibold mb-1">
                <i class="fas fa-dollar-sign me-2"></i>Monto
              </div>
              <div class="detail-value fw-bold text-success">$<span id="detalle-monto">-</span></div>
            </div>
          </div>
          <div class="col-md-6">
            <div class="detail-item bg-light p-3 rounded">
              <div class="detail-label text-muted fw-semibold mb-1">
                <i class="fas fa-credit-card me-2"></i>Método
              </div>
              <div class="detail-value fw-bold" id="detalle-metodo">-</div>
            </div>
          </div>
          <div class="col-md-6">
            <div class="detail-item bg-light p-3 rounded">
              <div class="detail-label text-muted fw-semibold mb-1">
                <i class="fas fa-hashtag me-2"></i>Referencia
              </div>
              <div class="detail-value fw-bold" id="detalle-referencia">-</div>
            </div>
          </div>
          <div class="col-md-6">
            <div class="detail-item bg-light p-3 rounded">
              <div class="detail-label text-muted fw-semibold mb-1">
                <i class="fas fa-university me-2"></i>Banco
              </div>
              <div class="detail-value fw-bold" id="detalle-banco">-</div>
            </div>
          </div>
          <div class="col-12">
            <div class="detail-item bg-light p-3 rounded">
              <div class="detail-label text-muted fw-semibold mb-2">
                <i class="fas fa-image me-2"></i>Captura del Pago
              </div>
              <div id="detalle-captura-content" class="text-center">
                <span class="text-muted">No hay imagen de captura disponible para este pago.</span>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer border-0 bg-light">
        <button type="button" class="btn btn-primary px-4" data-bs-dismiss="modal">
          <i class="fas fa-check me-2"></i>Entendido
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Modal Calculadora -->
<div class="modal fade modal-calc" id="modalCalc" tabindex="-1" aria-labelledby="modalCalcLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-lg">
    <div class="modal-content border-0 shadow-xl">
      <!-- Header con gradiente y patrón -->
      <div class="modal-header bg-gradient-success text-white border-0 position-relative overflow-hidden">
        <div class="calc-pattern"></div>
        <div class="position-relative z-1">
          <h5 class="modal-title fw-bold fs-4" id="modalCalcLabel">
            <i class="fas fa-calculator me-3 text-warning"></i>Calculadora de Montos y Conversión
          </h5>
          <p class="mb-0 opacity-90">Convierte entre USD, EUR y Bolívares con tasas BCV actualizadas</p>
        </div>
        <button type="button" class="btn-close btn-close-white position-relative z-1" data-bs-dismiss="modal" aria-label="Cerrar"></button>
      </div>
      
      <div class="modal-body p-5">
        <form id="calcForm">
          <!-- Sección de entrada principal -->
          <div class="calc-input-section mb-4">
            <div class="row g-4">
              <div class="col-lg-6">
                <div class="calc-input-card">
                  <label class="form-label fw-bold text-primary mb-3">
                    <i class="fas fa-coins me-2"></i>Monto a Convertir
                  </label>
                  <div class="input-group input-group-lg">
                    <span class="input-group-text bg-primary text-white border-0">
                      <i class="fas fa-dollar-sign"></i>
                    </span>
                    <input type="number" step="any" min="0" class="form-control form-control-lg border-0 bg-light" 
                           id="calcMonto" value="1" placeholder="Ingresa el monto">
                  </div>
                </div>
              </div>
              
              <div class="col-lg-6">
                <div class="calc-input-card">
                  <label class="form-label fw-bold text-primary mb-3">
                    <i class="fas fa-flag me-2"></i>Moneda de Origen
                  </label>
                  <div class="input-group input-group-lg">
                    <span class="input-group-text bg-success text-white border-0">
                      <i class="fas fa-globe"></i>
                    </span>
                    <select class="form-select form-select-lg border-0 bg-light" id="calcMoneda">
                      <option value="USD">🇺🇸 USD - Dólar Estadounidense</option>
                      <option value="EUR">🇪🇺 EUR - Euro</option>
                      <option value="BS">🇻🇪 Bs - Bolívar Venezolano</option>
                    </select>
                  </div>
                </div>
              </div>
            </div>
          </div>
          
          <!-- Sección de tasas -->
          <div class="calc-rates-section mb-4">
            <div class="d-flex justify-content-between align-items-center mb-3">
              <h6 class="text-muted fw-semibold mb-0 text-uppercase">
                <i class="fas fa-chart-line me-2"></i>Tasas de Cambio BCV
              </h6>
              <button type="button" class="btn btn-sm btn-outline-primary" onclick="cargarTasasLocales()" title="Cargar tasas locales">
                <i class="fas fa-download me-1"></i>Cargar
              </button>
            </div>
            <div class="row g-3">
              <div class="col-md-6">
                <div class="rate-card">
                  <div class="rate-header">
                    <i class="fas fa-dollar-sign text-success"></i>
                    <span class="rate-label">Tasa USD</span>
                  </div>
                  <div class="rate-value">
                    <input type="text" class="form-control border-0 bg-white" 
                           id="calcTasaBCV" value="0,00" placeholder="0,00">
                  </div>
                </div>
              </div>
              
              <div class="col-md-6">
                <div class="rate-card">
                  <div class="rate-header">
                    <i class="fas fa-euro-sign text-primary"></i>
                    <span class="rate-label">Tasa EUR</span>
                  </div>
                  <div class="rate-value">
                    <input type="text" class="form-control border-0 bg-white" 
                           id="calcTasaBCVEUR" value="0,00" placeholder="0,00">
                  </div>
                </div>
              </div>
            </div>
            <div class="text-center mt-2">
              <small class="text-muted">
                <i class="fas fa-info-circle me-1"></i>
                Las tasas se actualizan automáticamente o puedes cargarlas manualmente
              </small>
            </div>
          </div>
          
          <!-- Sección de resultados -->
          <div class="calc-results-section">
            <div class="results-card" id="calcResultados">
              <div class="results-header">
                <i class="fas fa-chart-pie text-warning me-2"></i>
                <span class="results-title">Resultados de Conversión</span>
                <div class="results-status ms-auto">
                  <span class="badge bg-light text-dark" id="calcStatus">Listo</span>
                </div>
              </div>
              <div class="results-content">
                <div class="text-center text-muted py-4">
                  <i class="fas fa-arrow-down fa-2x mb-2 opacity-50"></i>
                  <p class="mb-0">Ingresa un monto para ver la conversión</p>
                  <small class="d-block mt-2">
                    <i class="fas fa-info-circle me-1"></i>
                    Las tasas se actualizan automáticamente desde el BCV
                  </small>
                </div>
              </div>
            </div>
          </div>
        </form>
      </div>
      
      <!-- Footer con botones de acción -->
      <div class="modal-footer border-0 bg-light">
        <div class="d-flex gap-2 w-100">
          <button type="button" class="btn btn-outline-secondary flex-fill" data-bs-dismiss="modal">
            <i class="fas fa-times me-2"></i>Cerrar
          </button>
          <button type="button" class="btn btn-primary flex-fill" onclick="actualizarCalculadora()">
            <i class="fas fa-sync-alt me-2"></i>Actualizar
          </button>
          <button type="button" class="btn btn-success flex-fill" onclick="limpiarCalculadora()">
            <i class="fas fa-eraser me-2"></i>Limpiar
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
// Función para formatear tasas con separadores de miles
function formatearTasa(tasa) {
    return tasa.toLocaleString('es-VE', {
        minimumFractionDigits: 2,
        maximumFractionDigits: 2
    });
}

// Función para limpiar separadores de miles y convertir a número
function limpiarSeparadores(valor) {
    if (typeof valor === 'string') {
        return parseFloat(valor.replace(/\./g, '').replace(',', '.')) || 0;
    }
    return parseFloat(valor) || 0;
}

// Función para actualizar las tasas
function actualizarTasas() {
    // Mostrar indicador de actualización
    const ultimaActualizacion = document.getElementById('ultima-actualizacion');
    if (ultimaActualizacion) {
        ultimaActualizacion.innerHTML = '<i class="fas fa-sync-alt fa-spin"></i> Actualizando...';
    }
    
    // Intentar obtener tasas desde la API
    fetch('/api/tasas-actualizadas')
        .then(r => {
            if (!r.ok) {
                throw new Error(`Error HTTP: ${r.status}`);
            }
            return r.json();
        })
        .then(data => {
            if (!data || typeof data !== 'object') {
                throw new Error('Respuesta inválida del servidor');
            }

            // Validar que las tasas son números válidos
            const tasa_bcv = parseFloat(data.tasa_bcv);
            const tasa_bcv_eur = parseFloat(data.tasa_bcv_eur);

            if (isNaN(tasa_bcv) || tasa_bcv <= 0) {
                throw new Error('Tasa USD inválida en la respuesta');
            }

            // Actualizar los campos de tasa en el modal
            document.getElementById('calcTasaBCV').value = formatearTasa(tasa_bcv);
            document.getElementById('calcTasaBCVEUR').value = formatearTasa(tasa_bcv_eur || tasa_bcv * 1.15);
            
            // Actualizar la tarjeta de tasas (carrusel)
            const tasaBCVElement = document.getElementById('tasa-bcv-valor');
            if (tasaBCVElement) {
                tasaBCVElement.textContent = formatearTasa(tasa_bcv);
            }
            const tasaEURElement = document.getElementById('tasa-eur-valor');
            if (tasaEURElement) {
                tasaEURElement.textContent = formatearTasa(tasa_bcv_eur || tasa_bcv * 1.15);
            }
            
            // Actualizar la calculadora si está abierta
            actualizarCalculadora();
            
            // Mostrar mensaje de éxito con la fecha
            const fecha = new Date(data.fecha_actualizacion).toLocaleString();
            if (ultimaActualizacion) {
                ultimaActualizacion.innerHTML = `<i class="fas fa-check-circle text-success"></i> Actualizado: ${fecha}`;
                
                // Cambiar el ícono después de 3 segundos
                setTimeout(() => {
                    ultimaActualizacion.innerHTML = `<i class="fas fa-clock text-muted"></i> Última actualización: ${fecha}`;
                }, 3000);
            }
        })
        .catch(error => {
            console.error('Error actualizando tasas:', error);
            
            // Intentar usar las tasas por defecto o las que estén en la página
            cargarTasasLocales();
            
            if (ultimaActualizacion) {
                ultimaActualizacion.innerHTML = `<i class="fas fa-exclamation-circle text-danger"></i> Error: ${error.message}`;
            }
        });
}

// Función para cargar tasas locales como fallback
function cargarTasasLocales() {
    // Intentar obtener tasas desde elementos de la página
    const tasaBCVElement = document.getElementById('tasa-bcv-valor');
    const tasaEURElement = document.getElementById('tasa-eur-valor');
    
    let tasaUSD = 0;
    let tasaEUR = 0;
    
    if (tasaBCVElement) {
        const texto = tasaBCVElement.textContent.trim();
        tasaUSD = limpiarSeparadores(texto);
    }
    
    if (tasaEURElement) {
        const texto = tasaEURElement.textContent.trim();
        tasaEUR = limpiarSeparadores(texto);
    }
    
    // Si no hay tasas, usar valores por defecto
    if (tasaUSD <= 0) {
        tasaUSD = 145.75; // Tasa por defecto
    }
    
    if (tasaEUR <= 0) {
        tasaEUR = tasaUSD * 1.15; // EUR aproximado basado en USD
    }
    
    // Actualizar campos de la calculadora
    document.getElementById('calcTasaBCV').value = formatearTasa(tasaUSD);
    document.getElementById('calcTasaBCVEUR').value = formatearTasa(tasaEUR);
    
    // Actualizar calculadora
    actualizarCalculadora();
    
    console.log('Tasas locales cargadas:', { USD: tasaUSD, EUR: tasaEUR });
}

// Actualizar tasas al cargar la página
document.addEventListener('DOMContentLoaded', function() {
    actualizarTasas();
    // Actualizar tasas cada 5 minutos
    setInterval(actualizarTasas, 5 * 60 * 1000);

    // Filtros rápidos y totales dinámicos
    const filtroTexto = document.getElementById('filtroTexto');
    const filtroMetodo = document.getElementById('filtroMetodo');
    const tabla = document.getElementById('tablaPagos');
    const cuerpo = tabla.querySelector('tbody');
    const totalUSD = document.getElementById('totalListadoUSD');
    const totalBS = document.getElementById('totalListadoBS');
    const resumenMetodos = document.getElementById('resumenMetodos');
    const fechaDesde = document.getElementById('fechaDesde');
    const fechaHasta = document.getElementById('fechaHasta');

    function normalizar(s){ return (s||'').toString().toLowerCase(); }

    function aplicarFiltros() {
        const t = normalizar(filtroTexto.value);
        const m = normalizar(filtroMetodo.value);
        const d = fechaDesde && fechaDesde.value ? new Date(fechaDesde.value) : null;
        const h = fechaHasta && fechaHasta.value ? new Date(fechaHasta.value) : null;
        let sumUSD = 0, sumBS = 0, visibles = 0;
        const conteoMetodos = {};

        cuerpo.querySelectorAll('tr').forEach(tr => {
            const matchTexto = !t || [
                tr.dataset.factura,
                tr.dataset.fecha,
                tr.dataset.cliente,
                tr.dataset.referencia
            ].some(v => normalizar(v).includes(t));
            const matchMetodo = !m || normalizar(tr.dataset.metodo) === m;
            // Validación de rango de fechas (suponiendo formato YYYY-MM-DD o similar)
            let matchFecha = true;
            if ((d || h) && tr.dataset.fecha) {
                try {
                    const f = new Date(tr.dataset.fecha);
                    if (d && f < d) matchFecha = false;
                    if (h && f > h) matchFecha = false;
                } catch(e) { matchFecha = true; }
            }

            const visible = matchTexto && matchMetodo && matchFecha;
            tr.style.display = visible ? '' : 'none';
            if (visible) {
                sumUSD += parseFloat(tr.dataset.usd || '0');
                sumBS += parseFloat(tr.dataset.bs || '0');
                visibles++;
                const key = normalizar(tr.dataset.metodo);
                conteoMetodos[key] = (conteoMetodos[key] || 0) + 1;
            }
        });
        if (totalUSD) totalUSD.textContent = `$ ${sumUSD.toLocaleString('es-ES', {minimumFractionDigits:2})}`;
        if (totalBS) totalBS.textContent = `${sumBS.toLocaleString('es-ES', {minimumFractionDigits:2})} Bs`;

        // Resumen por método
        if (resumenMetodos) {
            const badges = Object.entries(conteoMetodos).sort((a,b)=>b[1]-a[1]).map(([k,v]) => {
                const label = (k||'').replace('_',' ').toUpperCase() || 'N/A';
                return `<span class="badge rounded-pill bg-light text-dark border">${label}: ${v}</span>`;
            });
            resumenMetodos.innerHTML = badges.join('\n');
        }
    }

    if (filtroTexto) filtroTexto.addEventListener('input', aplicarFiltros);
    if (filtroMetodo) filtroMetodo.addEventListener('change', aplicarFiltros);
    if (fechaDesde) fechaDesde.addEventListener('change', aplicarFiltros);
    if (fechaHasta) fechaHasta.addEventListener('change', aplicarFiltros);

    // Exportación CSV del listado filtrado
    const exportBtn = document.getElementById('exportCsv');
    if (exportBtn) exportBtn.addEventListener('click', () => {
        const rows = [['Factura','Fecha','Cliente','Método','Monto USD','Monto Bs']];
        cuerpo.querySelectorAll('tr').forEach(tr => {
            if (tr.style.display === 'none') return;
            const tds = tr.querySelectorAll('td');
            rows.push([
                tds[0].innerText.trim(),
                tds[1].innerText.trim(),
                tds[2].innerText.trim(),
                tds[3].innerText.trim(),
                tds[4].innerText.replace('$','').trim(),
                tds[5].innerText.replace(' Bs','').trim()
            ]);
        });
        const csv = rows.map(r => r.map(v => '"'+v.replaceAll('"','""')+'"').join(',')).join('\n');
        const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'pagos_filtrados.csv';
        document.body.appendChild(a);
        a.click();
        URL.revokeObjectURL(url);
        a.remove();
    });

    // Limpiar filtros
    const limpiar = document.getElementById('limpiarFiltros');
    if (limpiar) limpiar.addEventListener('click', () => {
        if (filtroTexto) filtroTexto.value = '';
        if (filtroMetodo) filtroMetodo.value = '';
        if (fechaDesde) fechaDesde.value = '';
        if (fechaHasta) fechaHasta.value = '';
        aplicarFiltros();
    });

    // Imprimir listado
    const btnImprimir = document.getElementById('imprimirListado');
    if (btnImprimir) btnImprimir.addEventListener('click', () => window.print());

    // Ordenamiento por columnas
    let orden = { key: null, dir: 1 };
    function comparar(a, b, key) {
        const va = a.dataset[key] || '';
        const vb = b.dataset[key] || '';
        if (key === 'usd' || key === 'bs') return (parseFloat(va) - parseFloat(vb)) * orden.dir;
        if (key === 'fecha') return (new Date(va) - new Date(vb)) * orden.dir;
        return va.localeCompare(vb) * orden.dir;
    }
    const ths = tabla.querySelectorAll('thead th.sortable');
    ths.forEach(th => th.addEventListener('click', () => {
        const key = th.dataset.key;
        const rows = Array.from(cuerpo.querySelectorAll('tr'));
        if (orden.key === key) { orden.dir *= -1; } else { orden.key = key; orden.dir = 1; }
        ths.forEach(t => t.classList.remove('asc','desc'));
        th.classList.add(orden.dir === 1 ? 'asc' : 'desc');
        rows.sort((a,b) => comparar(a,b,key)).forEach(tr => cuerpo.appendChild(tr));
        aplicarFiltros();
    }));

    // Paginación simple en cliente
    const pageSizeSel = document.getElementById('pageSize');
    const btnPrev = document.getElementById('prevPage');
    const btnNext = document.getElementById('nextPage');
    const pageInfo = document.getElementById('pageInfo');
    let pageSize = pageSizeSel ? parseInt(pageSizeSel.value, 10) : 0;
    let currentPage = 1;

    function paginasVisibles() {
        const visibles = Array.from(cuerpo.querySelectorAll('tr')).filter(tr => tr.style.display !== 'none');
        return visibles;
    }
    function renderPage() {
        const visibles = paginasVisibles();
        const total = visibles.length;
        if (!pageSize || pageSize <= 0) {
            visibles.forEach(tr => tr.style.display = '');
            if (pageInfo) pageInfo.textContent = `1 / 1`;
            return;
        }
        const totalPages = Math.max(1, Math.ceil(total / pageSize));
        if (currentPage > totalPages) currentPage = totalPages;
        visibles.forEach((tr, idx) => {
            const pageIdx = Math.floor(idx / pageSize) + 1;
            tr.style.display = pageIdx === currentPage ? '' : 'none';
        });
        if (pageInfo) pageInfo.textContent = `${currentPage} / ${totalPages}`;
    }
    function aplicarFiltrosYPaginar() {
        aplicarFiltros();
        currentPage = 1;
        renderPage();
    }
    if (pageSizeSel) pageSizeSel.addEventListener('change', () => {
        pageSize = parseInt(pageSizeSel.value, 10);
        currentPage = 1;
        renderPage();
    });
    if (btnPrev) btnPrev.addEventListener('click', () => { if (currentPage > 1) { currentPage--; renderPage(); } });
    if (btnNext) btnNext.addEventListener('click', () => { currentPage++; renderPage(); });

    // Mostrar/ocultar columnas
    const toggles = document.querySelectorAll('.col-toggle');
    function setColVisibility(colKey, visible) {
        const cls = colKey === 'acciones' ? 'col-acciones' : (colKey === 'usd' ? 'col-usd' : (colKey === 'bs' ? 'col-bs' : `col-${colKey}`));
        document.querySelectorAll(`.${cls}`).forEach(el => el.classList.toggle('hidden-col', !visible));
    }
    toggles.forEach(t => t.addEventListener('change', () => setColVisibility(t.dataset.col, t.checked)));

    // Inicializar
    aplicarFiltrosYPaginar();


});

// Modal de detalle de pago
var modalDetalle = document.getElementById('modalDetallePago');
modalDetalle.addEventListener('show.bs.modal', function (event) {
    var button = event.relatedTarget;
    document.getElementById('detalle-factura').textContent = button.getAttribute('data-factura');
    document.getElementById('detalle-fecha').textContent = button.getAttribute('data-fecha');
    document.getElementById('detalle-monto').textContent = parseFloat(button.getAttribute('data-monto')).toLocaleString('es-ES', {minimumFractionDigits:2});
    document.getElementById('detalle-metodo').textContent = button.getAttribute('data-metodo').replace('_',' ').toUpperCase();
    document.getElementById('detalle-referencia').textContent = button.getAttribute('data-referencia') || '-';
    document.getElementById('detalle-banco').textContent = button.getAttribute('data-banco') || '-';
    
    var captura = button.getAttribute('data-captura');
    var capturaContent = document.getElementById('detalle-captura-content');
    if (captura && captura !== 'None' && captura !== '') {
        capturaContent.innerHTML = `
            <img src="/static/${captura}" alt="Captura de pago" class="img-fluid rounded" style="max-width: 100%;">
            <a href="/static/${captura}" target="_blank" class="btn btn-sm btn-primary mt-2">
                <i class="fas fa-external-link-alt"></i> Ver en tamaño completo
            </a>
        `;
    } else {
        capturaContent.innerHTML = '<span class="text-muted">No hay imagen de captura disponible para este pago.</span>';
    }
});

// Calculadora de Montos y Conversión
function actualizarCalculadora() {
    // Actualizar estado visual
    const statusBadge = document.getElementById('calcStatus');
    if (statusBadge) {
        statusBadge.textContent = 'Calculando...';
        statusBadge.className = 'badge bg-warning text-dark';
    }
    
    const monto = parseFloat(document.getElementById('calcMonto').value) || 0;
    const moneda = document.getElementById('calcMoneda').value;
    
    const tasaBCV = limpiarSeparadores(document.getElementById('calcTasaBCV').value);
    const tasaBCVEUR = limpiarSeparadores(document.getElementById('calcTasaBCVEUR').value);
    
    if (monto <= 0) {
        mostrarMensajeCalculadora('Por favor, ingresa un monto válido mayor a 0');
        actualizarEstadoCalculadora('error', 'Error');
        return;
    }
    
    if (tasaBCV <= 0 || tasaBCVEUR <= 0) {
        mostrarMensajeCalculadora('Por favor, ingresa tasas de cambio válidas');
        actualizarEstadoCalculadora('error', 'Error');
        return;
    }
    
    let usd = 0, eur = 0, bs = 0;
    if (moneda === 'USD') {
        usd = monto;
        bs = monto * tasaBCV;
        eur = tasaBCVEUR ? (bs / tasaBCVEUR) : 0;
    } else if (moneda === 'EUR') {
        eur = monto;
        bs = monto * tasaBCVEUR;
        usd = tasaBCV ? (bs / tasaBCV) : 0;
    } else if (moneda === 'BS') {
        bs = monto;
        usd = tasaBCV ? (monto / tasaBCV) : 0;
        eur = tasaBCVEUR ? (monto / tasaBCVEUR) : 0;
    }
    
    // Mostrar resultados de manera atractiva
    mostrarResultadosCalculadora(usd, eur, bs, moneda);
    
    // Actualizar estado y mostrar notificación
    actualizarEstadoCalculadora('success', 'Completado');
    mostrarNotificacionCalculadora('Conversión realizada exitosamente', 'success');
}

function actualizarEstadoCalculadora(tipo, texto) {
    const statusBadge = document.getElementById('calcStatus');
    if (statusBadge) {
        statusBadge.textContent = texto;
        if (tipo === 'success') {
            statusBadge.className = 'badge bg-success text-white';
        } else if (tipo === 'error') {
            statusBadge.className = 'badge bg-danger text-white';
        } else if (tipo === 'warning') {
            statusBadge.className = 'badge bg-warning text-dark';
        } else {
            statusBadge.className = 'badge bg-light text-dark';
        }
    }
}

function mostrarMensajeCalculadora(mensaje) {
    const resultadosDiv = document.getElementById('calcResultados');
    resultadosDiv.innerHTML = `
        <div class="results-header">
            <i class="fas fa-info-circle text-info me-2"></i>
            <span class="results-title">Información</span>
            <div class="results-status ms-auto">
                <span class="badge bg-info text-white" id="calcStatus">Info</span>
            </div>
        </div>
        <div class="results-content">
            <div class="text-center text-muted py-4">
                <i class="fas fa-info-circle fa-2x mb-2 text-info opacity-50"></i>
                <p class="mb-0">${mensaje}</p>
            </div>
        </div>
    `;
}

function mostrarResultadosCalculadora(usd, eur, bs, monedaOrigen) {
    const resultadosDiv = document.getElementById('calcResultados');
    const monedaOrigenText = monedaOrigen === 'USD' ? 'Dólar' : monedaOrigen === 'EUR' ? 'Euro' : 'Bolívar';
    
    // Función para formatear números con separadores de miles
    function formatearNumero(numero) {
        return numero.toLocaleString('es-VE', {
            minimumFractionDigits: 2,
            maximumFractionDigits: 2
        });
    }
    
    resultadosDiv.innerHTML = `
        <div class="results-header">
            <i class="fas fa-chart-pie text-warning me-2"></i>
            <span class="results-title">Resultados de Conversión</span>
            <div class="results-status ms-auto">
                <span class="badge bg-success text-white" id="calcStatus">Completado</span>
            </div>
        </div>
        <div class="results-content">
            <div class="row g-3">
                <div class="col-md-4">
                    <div class="conversion-result">
                        <div class="currency-label">Dólar Estadounidense</div>
                        <div class="currency-value">
                            <span class="currency-symbol">$</span>${formatearNumero(usd)}
                        </div>
                        <small class="text-muted">USD</small>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="conversion-result">
                        <div class="currency-label">Euro</div>
                        <div class="currency-value">
                            <span class="currency-symbol">€</span>${formatearNumero(eur)}
                        </div>
                        <small class="text-muted">EUR</small>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="conversion-result">
                        <div class="currency-label">Bolívar Venezolano</div>
                        <div class="currency-value">
                            <span class="currency-symbol">Bs</span>${formatearNumero(bs)}
                        </div>
                        <small class="text-muted">Bs (BCV)</small>
                    </div>
                </div>
            </div>
            <div class="text-center mt-3">
                <small class="text-muted">
                    <i class="fas fa-info-circle me-1"></i>
                    Conversión desde ${monedaOrigenText}
                </div>
            </div>
        </div>
    `;
}

function limpiarCalculadora() {
    document.getElementById('calcMonto').value = '';
    document.getElementById('calcMoneda').selectedIndex = 0;
    actualizarEstadoCalculadora('info', 'Listo');
    mostrarMensajeCalculadora('Ingresa un monto para ver la conversión');
    mostrarNotificacionCalculadora('Calculadora limpiada', 'info');
}

function mostrarNotificacionCalculadora(mensaje, tipo) {
    // Crear notificación temporal
    const notificacion = document.createElement('div');
    notificacion.className = `alert alert-${tipo} alert-dismissible fade show position-fixed`;
    notificacion.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
    notificacion.innerHTML = `
        <i class="fas fa-${tipo === 'success' ? 'check-circle' : 'info-circle'} me-2"></i>
        ${mensaje}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    document.body.appendChild(notificacion);
    
    // Auto-ocultar después de 3 segundos
    setTimeout(() => {
        if (notificacion.parentNode) {
            notificacion.remove();
        }
    }, 3000);
}

// Eventos de la calculadora
document.getElementById('calcForm').addEventListener('input', actualizarCalculadora);

// Formatear automáticamente el campo de monto con separadores de miles
document.getElementById('calcMonto').addEventListener('blur', function() {
    const valor = parseFloat(this.value) || 0;
    if (valor > 0) {
        this.value = valor.toLocaleString('es-VE', {
            minimumFractionDigits: 2,
            maximumFractionDigits: 2
        });
    }
});

// Limpiar separadores al enfocar el campo de monto
document.getElementById('calcMonto').addEventListener('focus', function() {
    const valor = limpiarSeparadores(this.value);
    if (valor > 0) {
        this.value = valor.toString();
    }
});

// Formatear campos de tasa con separadores de miles
document.getElementById('calcTasaBCV').addEventListener('blur', function() {
    const valor = limpiarSeparadores(this.value);
    if (valor > 0) {
        this.value = formatearTasa(valor);
    }
});

document.getElementById('calcTasaBCVEUR').addEventListener('blur', function() {
    const valor = limpiarSeparadores(this.value);
    if (valor > 0) {
        this.value = formatearTasa(valor);
    }
});

// Limpiar separadores al enfocar campos de tasa
document.getElementById('calcTasaBCV').addEventListener('focus', function() {
    const valor = limpiarSeparadores(this.value);
    if (valor > 0) {
        this.value = valor.toString();
    }
});

document.getElementById('calcTasaBCVEUR').addEventListener('focus', function() {
    const valor = limpiarSeparadores(this.value);
    if (valor > 0) {
        this.value = valor.toString();
    }
});

// Obtener tasas automáticamente al abrir el modal
const modalCalc = document.getElementById('modalCalc');
modalCalc.addEventListener('show.bs.modal', function () {
    // Limpiar resultados al abrir
    mostrarMensajeCalculadora('Ingresa un monto para ver la conversión');
    
    // Intentar actualizar tasas automáticamente
    actualizarTasas();
    
    // Si después de 2 segundos no se cargaron las tasas, usar las locales
    setTimeout(() => {
        const tasaUSD = limpiarSeparadores(document.getElementById('calcTasaBCV').value);
        const tasaEUR = limpiarSeparadores(document.getElementById('calcTasaBCVEUR').value);
        
        if (tasaUSD <= 0 || tasaEUR <= 0) {
            console.log('Cargando tasas locales como fallback...');
            cargarTasasLocales();
        }
    }, 2000);
    
    // Inicializar estado
    actualizarEstadoCalculadora('info', 'Listo');
});

// Botón flotante abre el modal
const openCalcModal = document.getElementById('openCalcModal');
openCalcModal.addEventListener('click', function() {
    var modal = new bootstrap.Modal(document.getElementById('modalCalc'));
    modal.show();
});

// En el modal de la calculadora, agrega un pi animado junto al título
document.addEventListener('DOMContentLoaded', function() {
    const pi = document.createElement('span');
    pi.innerHTML = '<span style="font-size:1.5rem; color:#43e97b; margin-left:10px; animation: spinPi 2.5s linear infinite; display:inline-block;">&#960;</span>';
    const title = document.getElementById('modalCalcLabel');
    if (title) title.appendChild(pi);
});

// Animación para pi
const stylePi = document.createElement('style');
stylePi.innerHTML = `@keyframes spinPi { 0%{transform:rotate(0deg);} 100%{transform:rotate(360deg);} }`;
document.head.appendChild(stylePi);
</script>
{% endblock %} 