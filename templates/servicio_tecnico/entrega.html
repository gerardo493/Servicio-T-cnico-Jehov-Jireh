{% extends "base.html" %}

{% block title %}Entrega del Equipo - {{ orden.numero_orden }}{% endblock %}

{% block content %}
<style>
/* Neomorfismo - Estilos modernos */
.neo-container {
    background: #e0e5ec;
    min-height: 100vh;
    padding: 20px;
}

.neo-card {
    background: #e0e5ec;
    border-radius: 20px;
    box-shadow: 
        9px 9px 16px #a3b1c6,
        -9px -9px 16px #ffffff;
    border: none;
    transition: all 0.3s ease;
    margin-bottom: 20px;
}

.neo-card:hover {
    box-shadow: 
        12px 12px 20px #a3b1c6,
        -12px -12px 20px #ffffff;
    transform: translateY(-2px);
}

.neo-card-inset {
    background: #e0e5ec;
    border-radius: 15px;
    box-shadow: 
        inset 6px 6px 12px #a3b1c6,
        inset -6px -6px 12px #ffffff;
    border: none;
}

.neo-button {
    background: #e0e5ec;
    border: none;
    border-radius: 15px;
    box-shadow: 
        6px 6px 12px #a3b1c6,
        -6px -6px 12px #ffffff;
    color: #4a5568;
    font-weight: 600;
    transition: all 0.3s ease;
    padding: 12px 24px;
}

.neo-button:hover {
    box-shadow: 
        8px 8px 16px #a3b1c6,
        -8px -8px 16px #ffffff;
    transform: translateY(-2px);
    color: #2d3748;
}

.neo-button:active {
    box-shadow: 
        4px 4px 8px #a3b1c6,
        -4px -4px 8px #ffffff;
    transform: translateY(0);
}

.neo-button-primary {
    background: linear-gradient(145deg, #00ff88, #00cc6a);
    color: white;
    box-shadow: 
        6px 6px 12px #00cc6a,
        -6px -6px 12px #00ff88;
}

.neo-button-success {
    background: linear-gradient(145deg, #4ade80, #22c55e);
    color: white;
    box-shadow: 
        6px 6px 12px #22c55e,
        -6px -6px 12px #4ade80;
}

.neo-button-warning {
    background: linear-gradient(145deg, #fbbf24, #f59e0b);
    color: white;
    box-shadow: 
        6px 6px 12px #f59e0b,
        -6px -6px 12px #fbbf24;
}

.neo-input {
    background: #e0e5ec;
    border: none;
    border-radius: 15px;
    box-shadow: 
        inset 6px 6px 12px #a3b1c6,
        inset -6px -6px 12px #ffffff;
    padding: 12px 16px;
    color: #4a5568;
    transition: all 0.3s ease;
}

.neo-input:focus {
    outline: none;
    box-shadow: 
        inset 8px 8px 16px #a3b1c6,
        inset -8px -8px 16px #ffffff;
    color: #2d3748;
}

.neo-title {
    color: #2d3748;
    font-weight: 700;
    font-size: 1.5rem;
    margin-bottom: 0;
}

.neo-subtitle {
    color: #4a5568;
    font-weight: 600;
    font-size: 1.1rem;
    margin-bottom: 8px;
}

.neo-icon {
    color: #00ff88;
    font-size: 1.2rem;
}


/* Timeline */
.timeline {
    position: relative;
    padding-left: 30px;
}

.timeline::before {
    content: '';
    position: absolute;
    left: 15px;
    top: 0;
    bottom: 0;
    width: 3px;
    background: linear-gradient(145deg, #00ff88, #00cc6a);
    border-radius: 2px;
}

.timeline-item {
    position: relative;
    margin-bottom: 30px;
    padding-left: 30px;
}

.timeline-item::before {
    content: '';
    position: absolute;
    left: -22px;
    top: 5px;
    width: 15px;
    height: 15px;
    background: #00ff88;
    border-radius: 50%;
    box-shadow: 
        3px 3px 6px #00cc6a,
        -3px -3px 6px #00ff88;
}

.timeline-item.completed::before {
    background: #22c55e;
}

.timeline-item.current::before {
    background: #f59e0b;
    animation: pulse 2s infinite;
}

@keyframes pulse {
    0% { transform: scale(1); }
    50% { transform: scale(1.2); }
    100% { transform: scale(1); }
}

/* Badges de estado */
.badge-entregado {
    background: linear-gradient(145deg, #22c55e, #16a34a);
    color: white;
    font-size: 0.9rem;
    padding: 8px 16px;
    border-radius: 20px;
    font-weight: 600;
}

/* Campo de solo lectura */
.neo-input[readonly] {
    background-color: #f8f9fa;
    border-color: #dee2e6;
    color: #6c757d;
    cursor: not-allowed;
}

.neo-input[readonly]:focus {
    box-shadow: none;
    border-color: #dee2e6;
}

/* Responsive */
@media (max-width: 768px) {
    .neo-container {
        padding: 10px;
    }
    
    .neo-card {
        margin-bottom: 15px;
    }
}
</style>

<div class="neo-container">
    <div class="container-fluid">
        <!-- Header con informaci√≥n general -->
        <div class="neo-card">
            <div class="card-body p-4">
                <div class="row align-items-center">
                    <div class="col-md-8">
                        <h2 class="neo-title mb-2">
                            <i class="fas fa-shipping-fast neo-icon me-2"></i>
                            Entrega del Equipo
                        </h2>
                        <p class="text-muted mb-0">Orden: <strong>{{ orden.numero_orden }}</strong> | Cliente: <strong>{{ orden.cliente.nombre }}</strong></p>
                    </div>
                    <div class="col-md-4 text-end">
                        <div class="d-flex gap-2 justify-content-end">
                            <a href="/servicio-tecnico/orden/{{ orden.id }}" class="btn neo-button">
                                <i class="fas fa-eye me-2"></i>Ver Orden
                            </a>
                            <a href="/servicio-tecnico" class="btn neo-button">
                                <i class="fas fa-arrow-left me-2"></i>Volver
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <!-- Formulario de Entrega -->
            <div class="col-md-8">
                <form method="POST" id="formEntrega">
                    <div class="neo-card">
                        <div class="card-body p-4">
                            <h5 class="neo-title mb-4">
                                <i class="fas fa-clipboard-check neo-icon me-2"></i>Datos de la Entrega
                            </h5>
                            
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-4">
                                        <label for="fecha_entrega" class="neo-subtitle">Fecha y Hora de Entrega:</label>
                                        <input type="datetime-local" id="fecha_entrega" name="fecha_entrega" class="neo-input" 
                                               value="{{ orden.entrega.fecha_entrega if orden.entrega else '' }}" required>
                                    </div>
                                    
                                    <div class="mb-4">
                                        <label for="nombre_retira" class="neo-subtitle">Nombre de Quien Retira:</label>
                                        <input type="text" id="nombre_retira" name="nombre_retira" class="neo-input" 
                                               value="{{ orden.entrega.nombre_retira if orden.entrega else orden.cliente.nombre }}" required>
                                    </div>
                                    
                                    <div class="mb-4">
                                        <label for="cedula_retira" class="neo-subtitle">C√©dula/RIF:</label>
                                        <input type="text" id="cedula_retira" name="cedula_retira" class="neo-input" 
                                               value="{{ orden.entrega.cedula_retira if orden.entrega else orden.cliente.cedula_rif }}" required>
                                    </div>
                                    
                                    <div class="mb-4">
                                        <label for="telefono_retira" class="neo-subtitle">Tel√©fono:</label>
                                        <input type="tel" id="telefono_retira" name="telefono_retira" class="neo-input" 
                                               value="{{ orden.entrega.telefono_retira if orden.entrega else orden.cliente.telefono }}" required>
                                    </div>
                                </div>
                                
                                <div class="col-md-6">
                                    <div class="mb-4">
                                        <label for="tecnico_entrega" class="neo-subtitle">T√©cnico Responsable:</label>
                                        <input type="text" id="tecnico_entrega" name="tecnico_entrega" class="neo-input" 
                                               value="{{ orden.entrega.tecnico_entrega if orden.entrega else session.username or 'T√©cnico' }}" required>
                                    </div>
                                    
                                    <!-- Bot√≥n para registrar pago -->
                                    <div class="mb-4">
                                        <label class="neo-subtitle">Registro de Pago:</label>
                                        <div>
                                            <a href="/pagos-recibidos/nuevo?cliente_id={{ orden.cliente_id }}" class="btn neo-button-primary w-100 mb-2">
                                                <i class="fas fa-dollar-sign me-2"></i>
                                                Registrar Pago
                                            </a>
                                            <small class="text-muted d-block mb-2">El pago se registra en el m√≥dulo de Pagos Recibidos</small>
                                        </div>
                                    </div>
                                    
                                    <!-- Bot√≥n para enviar notificaci√≥n de pago -->
                                    <div class="mb-4">
                                        <label class="neo-subtitle">Notificaci√≥n al Cliente:</label>
                                        <div>
                                            <button type="button" class="btn neo-button-success w-100" onclick="enviarNotificacionPago()">
                                                <i class="fas fa-paper-plane me-2"></i>
                                                Enviar Notificaci√≥n de Pago
                                            </button>
                                            <small class="text-muted d-block mt-2">Env√≠a datos de cuentas y monto pendiente</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="mb-4">
                                <label for="observaciones_entrega" class="neo-subtitle">Observaciones de la Entrega:</label>
                                <textarea id="observaciones_entrega" name="observaciones_entrega" class="neo-input" rows="3" 
                                          placeholder="Observaciones adicionales sobre la entrega...">{{ orden.entrega.observaciones_entrega if orden.entrega else '' }}</textarea>
                            </div>
                            
                            {% if nota_entrega_existente %}
                            <div class="alert alert-info mb-3">
                                <i class="fas fa-info-circle me-2"></i>
                                <strong>Nota de Entrega Existente:</strong> Ya existe una nota de entrega para esta orden: 
                                <a href="{{ url_for('ver_nota_entrega', id=numero_nota_existente) }}" target="_blank" class="alert-link">
                                    {{ numero_nota_existente }}
                                </a>
                            </div>
                            {% endif %}
                            
                            <div class="text-end">
                                <button type="button" class="btn neo-button-warning me-2" onclick="generarNotaEntrega()">
                                    <i class="fas fa-file-pdf me-2"></i>
                                    {% if nota_entrega_existente %}
                                        Ver/Regenerar Nota de Entrega
                                    {% else %}
                                        Generar Nota de Entrega
                                    {% endif %}
                                </button>
                                <button type="submit" class="btn neo-button-success">
                                    <i class="fas fa-check me-2"></i>
                                    {% if orden.estado == 'entregado' %}
                                        Actualizar Entrega
                                    {% else %}
                                        Confirmar Entrega
                                    {% endif %}
                                </button>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            
            <!-- Resumen y Historial -->
            <div class="col-md-4">
                <!-- Resumen de Costos -->
                <div class="neo-card">
                    <div class="card-body p-4">
                        <h5 class="neo-title mb-4">
                            <i class="fas fa-calculator neo-icon me-2"></i>Resumen de Costos
                        </h5>
                        
                        <div class="info-item mb-2">
                            <span class="neo-subtitle">Presupuesto Original:</span>
                            <div class="info-value">${{ "%.2f"|format(orden.diagnostico.total_estimado) if orden.diagnostico else '0.00' }}</div>
                        </div>
                        
                        {% if orden.reparacion %}
                        <div class="info-item mb-2">
                            <span class="neo-subtitle">Repuestos Utilizados:</span>
                            <div class="info-value">
                                ${{ "%.2f"|format(orden.reparacion.total_repuestos) if orden.reparacion.total_repuestos else (orden.reparacion.repuestos_usados | sum(attribute='subtotal') if orden.reparacion.repuestos_usados else 0) }}
                                {% if not orden.reparacion.total_repuestos and orden.diagnostico.repuestos_seleccionados %}
                                <button class="btn btn-sm btn-outline-primary ms-2" onclick="recalcularRepuestos()">
                                    <i class="fas fa-sync-alt"></i> Recalcular
                                </button>
                                {% endif %}
                            </div>
                        </div>
                        
                        <div class="info-item mb-2">
                            <span class="neo-subtitle">Costo Adicional:</span>
                            <div class="info-value">${{ "%.2f"|format(orden.reparacion.costo_adicional) if orden.reparacion.costo_adicional else '0.00' }}</div>
                        </div>
                        
                        <div class="info-item mb-2">
                            <span class="neo-subtitle">Mano de Obra:</span>
                            <div class="info-value">${{ "%.2f"|format((orden.diagnostico.total_estimado * 0.3) if orden.diagnostico and orden.diagnostico.total_estimado else 0) }}</div>
                        </div>
                        {% endif %}
                        
                        <hr>
                        
                        <div class="info-item mb-2">
                            <span class="neo-subtitle"><strong>Total Final:</strong></span>
                            <div class="info-value"><strong id="total-final">$0.00</strong></div>
                        </div>
                        
                    </div>
                </div>
                
                <!-- Historial Completo -->
                <div class="neo-card mt-3">
                    <div class="card-body p-4">
                        <h5 class="neo-title mb-4">
                            <i class="fas fa-history neo-icon me-2"></i>Historial Completo
                        </h5>
                        
                        <div class="timeline" id="historial-completo">
                            <!-- Historial se cargar√° din√°micamente -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal para personalizar notificaci√≥n de pago -->
<div class="modal fade" id="modalNotificacionPago" tabindex="-1" aria-labelledby="modalNotificacionPagoLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content" style="background: #e0e5ec; border-radius: 20px; border: none;">
            <div class="modal-header" style="border-bottom: 2px solid #a3b1c6;">
                <h5 class="modal-title" id="modalNotificacionPagoLabel">
                    <i class="fas fa-paper-plane me-2" style="color: #00ff88;"></i>
                    Personalizar Notificaci√≥n de Pago
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-4">
                <!-- Selecci√≥n de canales de env√≠o -->
                <div class="mb-4">
                    <label class="neo-subtitle mb-3">Canales de Env√≠o:</label>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-check mb-3">
                                <input class="form-check-input" type="checkbox" id="canal_whatsapp" checked>
                                <label class="form-check-label" for="canal_whatsapp">
                                    <i class="fab fa-whatsapp me-2" style="color: #25D366;"></i>
                                    WhatsApp
                                </label>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-check mb-3">
                                <input class="form-check-input" type="checkbox" id="canal_email" checked>
                                <label class="form-check-label" for="canal_email">
                                    <i class="fas fa-envelope me-2" style="color: #EA4335;"></i>
                                    Email
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
                
                <hr style="border-color: #a3b1c6;">
                
                <!-- Selecci√≥n de m√©todos de pago a incluir -->
                <div class="mb-4">
                    <label class="neo-subtitle mb-3">M√©todos de Pago a Incluir:</label>
                    <div id="metodos-pago-container" class="row">
                        <div class="col-12 text-center py-3">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Cargando m√©todos de pago...</span>
                            </div>
                            <p class="text-muted mt-2">Cargando m√©todos de pago desde la configuraci√≥n...</p>
                        </div>
                    </div>
                </div>
                
                <!-- Vista previa del mensaje -->
                <div class="mb-3">
                    <label class="neo-subtitle mb-2">Vista Previa del Mensaje:</label>
                    <div class="neo-card-inset p-3" style="max-height: 200px; overflow-y: auto;">
                        <pre id="vistaPreviaMensaje" style="white-space: pre-wrap; font-size: 0.9rem; margin: 0; color: #4a5568;"></pre>
                    </div>
                </div>
            </div>
            <div class="modal-footer" style="border-top: 2px solid #a3b1c6;">
                <button type="button" class="btn neo-button" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn neo-button-success" onclick="confirmarEnvioNotificacion()">
                    <i class="fas fa-paper-plane me-2"></i>
                    Enviar Notificaci√≥n
                </button>
            </div>
        </div>
    </div>
</div>

<script>
// Inicializar p√°gina
document.addEventListener('DOMContentLoaded', function() {
    cargarHistorialCompleto();
    calcularTotalFinal();
});

// Recalcular repuestos utilizados
function recalcularRepuestos() {
    fetch('/servicio-tecnico/orden/{{ orden.id }}/recalcular-repuestos', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            mostrarNotificacion(data.message, 'success');
            // Recargar la p√°gina para mostrar los datos actualizados
            setTimeout(() => {
                window.location.reload();
            }, 1500);
        } else {
            mostrarNotificacion('Error: ' + data.message, 'danger');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        mostrarNotificacion('Error al recalcular repuestos', 'danger');
    });
}


// Calcular total final
function calcularTotalFinal() {
    const presupuestoOriginal = {{ (orden.diagnostico.total_estimado if orden.diagnostico and orden.diagnostico.total_estimado else 0) | safe }};
    const repuestos = {{ (orden.reparacion.total_repuestos if orden.reparacion and orden.reparacion.total_repuestos else 0) | safe }};
    const adicional = {{ (orden.reparacion.costo_adicional if orden.reparacion and orden.reparacion.costo_adicional else 0) | safe }};
    
    // L√≥gica corregida: igual que en reparaci√≥n
    let totalFinal;
    let manoObraBase = 0;
    
    if (repuestos > 0) {
        // Caso 1: Hay repuestos utilizados
        // Calcular mano de obra base (30% del presupuesto original como mano de obra)
        manoObraBase = presupuestoOriginal * 0.3;
        totalFinal = repuestos + adicional + manoObraBase;
    } else {
        // Caso 2: No hay repuestos utilizados, usar presupuesto original
        manoObraBase = presupuestoOriginal; // Todo el presupuesto es mano de obra
        totalFinal = presupuestoOriginal + adicional;
    }
    
    document.getElementById('total-final').textContent = `$${totalFinal.toFixed(2)}`;
}


// Cargar historial completo
function cargarHistorialCompleto() {
    const timeline = document.getElementById('historial-completo');
    const eventos = [];
    
    // Eventos del historial de estados
    {% if orden.historial_estados %}
    {% for evento in orden.historial_estados %}
    {% if evento.estado %}
    eventos.push({
        fecha: '{{ evento.fecha if evento.fecha else "" }}',
        titulo: '{{ (evento.estado | replace("_", " ")) | title }}',
        descripcion: '{{ evento.comentarios if evento.comentarios else "" }}',
        usuario: '{{ evento.usuario if evento.usuario else "" }}',
        tipo: 'completed'
    });
    {% endif %}
    {% endfor %}
    {% endif %}
    
    // Agregar eventos espec√≠ficos
    eventos.push({
        fecha: '{{ orden.fecha_recepcion }}',
        titulo: 'Orden Recibida',
        descripcion: 'Orden de servicio creada y recibida',
        usuario: 'Sistema',
        tipo: 'completed'
    });
    
    {% if orden.diagnostico %}
    eventos.push({
        fecha: '{{ orden.diagnostico.fecha_diagnostico if orden.diagnostico.fecha_diagnostico else orden.fecha_actualizacion }}',
        titulo: 'Diagn√≥stico Completado',
        descripcion: 'Diagn√≥stico t√©cnico realizado y presupuesto aprobado',
        usuario: '{{ orden.diagnostico.tecnico_diagnostico if orden.diagnostico.tecnico_diagnostico else "T√©cnico" }}',
        tipo: 'completed'
    });
    {% endif %}
    
    {% if orden.reparacion %}
    eventos.push({
        fecha: '{{ orden.reparacion.fecha_actualizacion if orden.reparacion.fecha_actualizacion else orden.fecha_actualizacion }}',
        titulo: 'Reparaci√≥n Completada',
        descripcion: 'Equipo reparado y listo para entrega',
        usuario: '{{ orden.reparacion.tecnico_responsable if orden.reparacion.tecnico_responsable else "T√©cnico" }}',
        tipo: 'completed'
    });
    {% endif %}
    
    // Ordenar eventos por fecha
    eventos.sort((a, b) => new Date(a.fecha) - new Date(b.fecha));
    
    // Renderizar timeline
    timeline.innerHTML = '';
    eventos.forEach(evento => {
        const item = document.createElement('div');
        item.className = `timeline-item ${evento.tipo}`;
        item.innerHTML = `
            <div class="neo-card-inset p-3">
                <h6 class="mb-1">${evento.titulo}</h6>
                <p class="text-muted mb-1">${evento.descripcion}</p>
                <small class="text-muted">${evento.fecha} - ${evento.usuario}</small>
            </div>
        `;
        timeline.appendChild(item);
    });
}

// Generar nota de entrega
function generarNotaEntrega() {
    // Permitir generar nota en cualquier estado (reparado, entregado, listo_entrega)
    // No validar estado para permitir flexibilidad
    
    // Confirmar generaci√≥n
    if (!confirm('¬øEst√° seguro de generar la nota de entrega para esta orden?')) {
        return;
    }
    
    // Mostrar indicador de carga
    const boton = event.target;
    const textoOriginal = boton.innerHTML;
    boton.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Generando...';
    boton.disabled = true;
    
    // Enviar solicitud al backend
    fetch('/servicio-tecnico/orden/{{ orden.id }}/generar-factura', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            if (data.ya_existia) {
                mostrarNotificacion(`Ya existe una nota de entrega para esta orden: ${data.numero_nota}`, 'info');
            } else {
                mostrarNotificacion(`Nota de entrega generada exitosamente: ${data.numero_nota}`, 'success');
            }
            
            // Abrir la nota de entrega en una nueva pesta√±a
            setTimeout(() => {
                window.open(`/notas-entrega/${data.numero_nota}/imprimir`, '_blank');
            }, 1500);
        } else {
            mostrarNotificacion('Error: ' + (data.message || 'Error desconocido'), 'danger');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        mostrarNotificacion('Error al generar la nota de entrega', 'danger');
    })
    .finally(() => {
        // Restaurar bot√≥n
        boton.innerHTML = textoOriginal;
        boton.disabled = false;
    });
}

// Mostrar notificaci√≥n
function mostrarNotificacion(mensaje, tipo) {
    const notificacion = document.createElement('div');
    notificacion.className = `alert alert-${tipo} alert-dismissible fade show position-fixed`;
    notificacion.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
    notificacion.innerHTML = `
        ${mensaje}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    document.body.appendChild(notificacion);
    
    setTimeout(() => {
        if (notificacion.parentNode) {
            notificacion.parentNode.removeChild(notificacion);
        }
    }, 5000);
}

// Abrir modal de notificaci√≥n de pago
function enviarNotificacionPago() {
    // Cargar monto pendiente
    cargarMontoPendiente();
    
    // Cargar m√©todos de pago desde la configuraci√≥n
    cargarMetodosPagoDisponibles();
    
    // Mostrar modal
    const modal = new bootstrap.Modal(document.getElementById('modalNotificacionPago'));
    modal.show();
    
    // Actualizar vista previa cuando cambien las selecciones
    setTimeout(() => {
        document.querySelectorAll('.metodo-pago, #canal_whatsapp, #canal_email').forEach(element => {
            element.removeEventListener('change', actualizarVistaPrevia);
            element.addEventListener('change', actualizarVistaPrevia);
        });
        
        // Actualizar vista previa inicial despu√©s de cargar m√©todos
        actualizarVistaPrevia();
    }, 500);
}

// Cargar monto pendiente desde el servidor
let montoPendienteData = { monto_pendiente_usd: 0, monto_pendiente_bs: 0, notas_pendientes: [] };

function cargarMontoPendiente() {
    fetch('/servicio-tecnico/orden/{{ orden.id }}/monto-pendiente')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                montoPendienteData = data;
                actualizarVistaPrevia();
            }
        })
        .catch(error => {
            console.error('Error cargando monto pendiente:', error);
        });
}

// Cargar m√©todos de pago disponibles desde la configuraci√≥n
function cargarMetodosPagoDisponibles() {
    const container = document.getElementById('metodos-pago-container');
    
    fetch('/api/metodos-pago-habilitados')
        .then(response => response.json())
        .then(data => {
            if (data.success && data.metodos && data.metodos.length > 0) {
                container.innerHTML = '';
                
                // Dividir m√©todos en dos columnas
                const mitad = Math.ceil(data.metodos.length / 2);
                const columna1 = data.metodos.slice(0, mitad);
                const columna2 = data.metodos.slice(mitad);
                
                // Crear columnas
                const col1 = document.createElement('div');
                col1.className = 'col-md-6';
                
                const col2 = document.createElement('div');
                col2.className = 'col-md-6';
                
                // Agregar m√©todos a la primera columna
                columna1.forEach(metodo => {
                    const div = document.createElement('div');
                    div.className = 'form-check mb-2';
                    div.innerHTML = `
                        <input class="form-check-input metodo-pago" type="checkbox" id="metodo_${metodo.clave}" value="${metodo.clave}" checked>
                        <label class="form-check-label" for="metodo_${metodo.clave}">
                            ${metodo.icono} ${metodo.nombre}
                        </label>
                    `;
                    col1.appendChild(div);
                });
                
                // Agregar m√©todos a la segunda columna
                columna2.forEach(metodo => {
                    const div = document.createElement('div');
                    div.className = 'form-check mb-2';
                    div.innerHTML = `
                        <input class="form-check-input metodo-pago" type="checkbox" id="metodo_${metodo.clave}" value="${metodo.clave}" checked>
                        <label class="form-check-label" for="metodo_${metodo.clave}">
                            ${metodo.icono} ${metodo.nombre}
                        </label>
                    `;
                    col2.appendChild(div);
                });
                
                container.appendChild(col1);
                if (columna2.length > 0) {
                    container.appendChild(col2);
                }
                
                // Agregar event listeners a los nuevos checkboxes
                document.querySelectorAll('.metodo-pago').forEach(element => {
                    element.addEventListener('change', actualizarVistaPrevia);
                });
                
                // Actualizar vista previa despu√©s de cargar
                actualizarVistaPrevia();
            } else {
                container.innerHTML = `
                    <div class="col-12">
                        <div class="alert alert-warning">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            No hay m√©todos de pago habilitados en la configuraci√≥n del sistema.
                            <br>
                            <small>Configure los m√©todos de pago en <a href="/configuracion">Configuraci√≥n del Sistema</a></small>
                        </div>
                    </div>
                `;
            }
        })
        .catch(error => {
            console.error('Error cargando m√©todos de pago:', error);
            container.innerHTML = `
                <div class="col-12">
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-circle me-2"></i>
                        Error al cargar los m√©todos de pago. Por favor, intente nuevamente.
                    </div>
                </div>
            `;
        });
}

// Actualizar vista previa del mensaje
function actualizarVistaPrevia() {
    // Obtener m√©todos seleccionados
    const metodosSeleccionados = [];
    document.querySelectorAll('.metodo-pago:checked').forEach(checkbox => {
        metodosSeleccionados.push(checkbox.value);
    });
    
    // Obtener canales seleccionados
    const canales = [];
    if (document.getElementById('canal_whatsapp').checked) canales.push('WhatsApp');
    if (document.getElementById('canal_email').checked) canales.push('Email');
    
    // Construir vista previa con datos reales
    let vistaPrevia = 'üí≥ RECORDATORIO DE PAGO PENDIENTE\n\n';
    vistaPrevia += `üë§ Cliente: {{ orden.cliente.nombre if orden.cliente else 'Cliente' }}\n`;
    vistaPrevia += `üìã Orden: {{ orden.numero_orden if orden.numero_orden else orden.id }}\n\n`;
    vistaPrevia += 'üí∞ MONTO PENDIENTE:\n';
    
    if (montoPendienteData.monto_pendiente_usd > 0) {
        vistaPrevia += `‚Ä¢ USD: $${montoPendienteData.monto_pendiente_usd.toFixed(2)}\n`;
        vistaPrevia += `‚Ä¢ Bs: Bs ${montoPendienteData.monto_pendiente_bs.toLocaleString('es-VE', {minimumFractionDigits: 2, maximumFractionDigits: 2})}\n\n`;
    } else {
        vistaPrevia += '‚Ä¢ USD: $0.00\n';
        vistaPrevia += '‚Ä¢ Bs: Bs 0,00\n\n';
    }
    
    if (metodosSeleccionados.length > 0) {
        vistaPrevia += 'M√âTODOS DE PAGO SELECCIONADOS:\n';
        const nombresMetodos = {
            'efectivo': 'üíµ Efectivo',
            'transferencia': 'üè¶ Transferencia Bancaria',
            'pago_movil': 'üì± Pago M√≥vil',
            'zelle': 'üí≥ Zelle',
            'paypal': 'üí∞ PayPal',
            'binance': '‚Çø Binance'
        };
        metodosSeleccionados.forEach(metodo => {
            vistaPrevia += `‚Ä¢ ${nombresMetodos[metodo] || metodo.charAt(0).toUpperCase() + metodo.slice(1).replace('_', ' ')}\n`;
        });
    } else {
        vistaPrevia += '‚ö†Ô∏è No se han seleccionado m√©todos de pago\n';
    }
    
    vistaPrevia += `\nüì§ Se enviar√° por: ${canales.length > 0 ? canales.join(' y ') : 'Ning√∫n canal seleccionado'}`;
    
    document.getElementById('vistaPreviaMensaje').textContent = vistaPrevia;
}

// Confirmar y enviar notificaci√≥n
function confirmarEnvioNotificacion() {
    // Validar que al menos un canal est√© seleccionado
    const whatsapp = document.getElementById('canal_whatsapp').checked;
    const email = document.getElementById('canal_email').checked;
    
    if (!whatsapp && !email) {
        mostrarNotificacion('Debe seleccionar al menos un canal de env√≠o (WhatsApp o Email)', 'warning');
        return;
    }
    
    // Obtener m√©todos de pago seleccionados
    const metodosSeleccionados = [];
    document.querySelectorAll('.metodo-pago:checked').forEach(checkbox => {
        metodosSeleccionados.push(checkbox.value);
    });
    
    // Cerrar modal
    const modal = bootstrap.Modal.getInstance(document.getElementById('modalNotificacionPago'));
    modal.hide();
    
    // Enviar notificaci√≥n
    const boton = document.querySelector('button[onclick="enviarNotificacionPago()"]');
    const textoOriginal = boton.innerHTML;
    boton.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Enviando...';
    boton.disabled = true;
    
    fetch('/servicio-tecnico/orden/{{ orden.id }}/enviar-notificacion-pago', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-Requested-With': 'XMLHttpRequest'
        },
        body: JSON.stringify({
            metodos_pago: metodosSeleccionados,
            enviar_whatsapp: whatsapp,
            enviar_email: email
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            let mensaje = 'Notificaci√≥n enviada exitosamente';
            if (data.resultados) {
                const metodos = [];
                if (data.resultados.whatsapp) metodos.push('WhatsApp');
                if (data.resultados.email) metodos.push('Email');
                if (metodos.length > 0) {
                    mensaje += ` por ${metodos.join(' y ')}`;
                }
                
                // Si hay enlace de WhatsApp, abrirlo
                if (data.resultados.enlace_whatsapp) {
                    window.open(data.resultados.enlace_whatsapp, '_blank');
                }
            }
            
            mostrarNotificacion(mensaje, 'success');
            
            if (data.monto_pendiente_usd) {
                mostrarNotificacion(`Monto pendiente: $${data.monto_pendiente_usd.toFixed(2)} USD`, 'info');
            }
        } else {
            mostrarNotificacion('Error: ' + (data.message || 'Error desconocido'), 'danger');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        mostrarNotificacion('Error al enviar la notificaci√≥n', 'danger');
    })
    .finally(() => {
        boton.innerHTML = textoOriginal;
        boton.disabled = false;
    });
}

// Manejar env√≠o del formulario
document.getElementById('formEntrega').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const formData = new FormData(this);
    
    fetch('/servicio-tecnico/orden/{{ orden.id }}/entrega', {
        method: 'POST',
        body: formData,
        headers: {
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
    })
    .then(data => {
        if (data.success) {
            mostrarNotificacion('Entrega registrada exitosamente', 'success');
            setTimeout(() => {
                window.location.href = '/servicio-tecnico';
            }, 2000);
        } else {
            mostrarNotificacion('Error al registrar entrega: ' + data.message, 'danger');
        }
    })
    .catch(error => {
        console.error('Error completo:', error);
        mostrarNotificacion('Error al registrar entrega: ' + error.message, 'danger');
    });
});
</script>
{% endblock %}
