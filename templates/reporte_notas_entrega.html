{% extends "base.html" %}

{% block title %}Reporte Mejorado de Notas de Entrega{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Header del Reporte -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="neo-card">
                <div class="d-flex justify-content-between align-items-center flex-wrap">
                    <div>
                        <h2 class="mb-1">
                            <i class="fas fa-chart-line me-2"></i>
                            Reporte Avanzado de Notas de Entrega
                        </h2>
                        <p class="text-muted mb-0">Análisis completo con filtros avanzados, gráficos y comparaciones</p>
                    </div>
                    <div class="mt-2">
                        <div class="btn-group" role="group">
                            <button type="button" class="btn btn-primary dropdown-toggle" data-bs-toggle="dropdown">
                                <i class="fas fa-download me-2"></i>Exportar
                            </button>
                            <ul class="dropdown-menu">
                                {% if config.get('reportes', {}).get('exportacion_csv', True) %}
                                <li><a class="dropdown-item" href="#" onclick="exportarReporte('csv')">
                                    <i class="fas fa-file-csv me-2"></i>Exportar a CSV
                                </a></li>
                                {% endif %}
                                {% if config.get('reportes', {}).get('exportacion_pdf', True) %}
                                <li><a class="dropdown-item" href="#" onclick="imprimirReporte()">
                                    <i class="fas fa-file-pdf me-2"></i>Exportar a PDF
                                </a></li>
                                {% endif %}
                                {% if config.get('reportes', {}).get('exportacion_json', True) %}
                                <li><a class="dropdown-item" href="#" onclick="exportarReporte('json')">
                                    <i class="fas fa-file-code me-2"></i>Exportar a JSON
                                </a></li>
                                {% endif %}
                                {% if config.get('reportes', {}).get('exportacion_html', True) %}
                                <li><a class="dropdown-item" href="#" onclick="exportarReporte('html')">
                                    <i class="fas fa-file-alt me-2"></i>Exportar a HTML
                                </a></li>
                                {% endif %}
                            </ul>
                        </div>
                        <a href="/notas-entrega" class="btn btn-secondary ms-2">
                            <i class="fas fa-arrow-left me-2"></i>Volver
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Filtros Avanzados -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="neo-card">
                <h5 class="mb-3">
                    <i class="fas fa-filter me-2"></i>
                    Filtros Avanzados
                    <button class="btn btn-sm btn-link" type="button" data-bs-toggle="collapse" data-bs-target="#filtrosAvanzados">
                        <i class="fas fa-chevron-down"></i>
                    </button>
                </h5>
                <form method="GET" action="/notas-entrega/reporte" id="formFiltros">
                    <div class="row g-3">
                        <!-- Filtros Básicos -->
                        <div class="col-md-3">
                            <label class="form-label">Mes</label>
                            <select name="mes" id="mes" class="form-select">
                                <option value="">Todos</option>
                                {% for mes in meses %}
                                <option value="{{ mes.valor }}" {% if mes_filtro == mes.valor %}selected{% endif %}>
                                    {{ mes.nombre }}
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Año</label>
                            <select name="año" id="año" class="form-select">
                                <option value="">Todos</option>
                                {% for año in años %}
                                <option value="{{ año.valor }}" {% if año_filtro == año.valor %}selected{% endif %}>
                                    {{ año.nombre }}
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Fecha Desde</label>
                            <input type="date" name="fecha_desde" id="fecha_desde" class="form-control" value="{{ fecha_desde }}">
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Fecha Hasta</label>
                            <input type="date" name="fecha_hasta" id="fecha_hasta" class="form-control" value="{{ fecha_hasta }}">
                        </div>
                        
                        <!-- Filtros Avanzados (Colapsable) -->
                        {% if config.get('reportes', {}).get('filtros_avanzados', True) %}
                        <div class="collapse" id="filtrosAvanzados">
                            <div class="row g-3 mt-2">
                                <div class="col-md-4">
                                    <label class="form-label">Cliente</label>
                                    <input type="text" name="cliente" id="cliente" class="form-control" 
                                           value="{{ cliente_filtro }}" placeholder="Buscar por nombre...">
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label">Estado</label>
                                    <select name="estado" id="estado" class="form-select">
                                        <option value="">Todos</option>
                                        <option value="PENDIENTE_ENTREGA" {% if estado_filtro == 'PENDIENTE_ENTREGA' %}selected{% endif %}>Pendiente</option>
                                        <option value="ENTREGADO" {% if estado_filtro == 'ENTREGADO' %}selected{% endif %}>Entregado</option>
                                        <option value="PAGADA" {% if estado_filtro == 'PAGADA' %}selected{% endif %}>Pagada</option>
                                        <option value="ANULADO" {% if estado_filtro == 'ANULADO' %}selected{% endif %}>Anulado</option>
                                    </select>
                                </div>
                                <div class="col-md-2">
                                    <label class="form-label">Monto Mín. USD</label>
                                    <input type="number" name="monto_min" id="monto_min" class="form-control" 
                                           value="{{ monto_min }}" step="0.01" min="0">
                                </div>
                                <div class="col-md-2">
                                    <label class="form-label">Monto Máx. USD</label>
                                    <input type="number" name="monto_max" id="monto_max" class="form-control" 
                                           value="{{ monto_max }}" step="0.01" min="0">
                                </div>
                            </div>
                            
                            <!-- Comparación de Períodos -->
                            {% if config.get('reportes', {}).get('comparaciones_periodos', True) %}
                            <div class="row g-3 mt-2">
                                <div class="col-md-12">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" name="comparar" id="comparar" 
                                               {% if comparar_periodo %}checked{% endif %}>
                                        <label class="form-check-label" for="comparar">
                                            <strong>Comparar con período anterior</strong>
                                        </label>
                                    </div>
                                </div>
                                <div class="col-md-6" id="periodoComparacion" style="display: {% if comparar_periodo %}block{% else %}none{% endif %};">
                                    <label class="form-label">Período de Comparación</label>
                                    <select name="periodo_comparacion" class="form-select">
                                        <option value="mes_anterior" {% if periodo_comparacion == 'mes_anterior' %}selected{% endif %}>Mes Anterior</option>
                                        <option value="año_anterior" {% if periodo_comparacion == 'año_anterior' %}selected{% endif %}>Año Anterior (Mismo Mes)</option>
                                    </select>
                                </div>
                            </div>
                            {% endif %}
                        </div>
                        {% endif %}
                        
                        <!-- Botones de Acción -->
                        <div class="col-12">
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-search me-2"></i>Aplicar Filtros
                            </button>
                            <a href="/notas-entrega/reporte" class="btn btn-secondary">
                                <i class="fas fa-times me-2"></i>Limpiar
                            </a>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Estadísticas Resumen Mejoradas -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="neo-card text-center">
                <div class="neo-stat-card">
                    <div class="stat-icon">
                        <i class="fas fa-file-invoice"></i>
                    </div>
                    <div class="stat-content">
                        <h3 class="stat-number">{{ total_notas }}</h3>
                        <p class="stat-label">Total Notas</p>
                        {% if comparar_periodo and config.get('reportes', {}).get('comparaciones_periodos', True) %}
                        <small class="stat-variacion {% if variacion_notas >= 0 %}text-success{% else %}text-danger{% endif %}">
                            <i class="fas fa-arrow-{% if variacion_notas >= 0 %}up{% else %}down{% endif %}"></i>
                            {{ "%.1f"|format(variacion_notas|abs) }}% vs período anterior
                        </small>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="neo-card text-center">
                <div class="neo-stat-card">
                    <div class="stat-icon usd">
                        <i class="fas fa-dollar-sign"></i>
                    </div>
                    <div class="stat-content">
                        <h3 class="stat-number">${{ "%.2f"|format(total_usd) }}</h3>
                        <p class="stat-label">Total USD</p>
                        {% if comparar_periodo and config.get('reportes', {}).get('comparaciones_periodos', True) %}
                        <small class="stat-variacion {% if variacion_usd >= 0 %}text-success{% else %}text-danger{% endif %}">
                            <i class="fas fa-arrow-{% if variacion_usd >= 0 %}up{% else %}down{% endif %}"></i>
                            {{ "%.1f"|format(variacion_usd|abs) }}% vs período anterior
                        </small>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="neo-card text-center">
                <div class="neo-stat-card">
                    <div class="stat-icon bs">
                        <i class="fas fa-coins"></i>
                    </div>
                    <div class="stat-content">
                        <h3 class="stat-number">Bs {{ "%.2f"|format(total_bs) }}</h3>
                        <p class="stat-label">Total Bs</p>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="neo-card text-center">
                <div class="neo-stat-card">
                    <div class="stat-icon promedio">
                        <i class="fas fa-chart-bar"></i>
                    </div>
                    <div class="stat-content">
                        <h3 class="stat-number">${{ "%.2f"|format(promedio_usd) }}</h3>
                        <p class="stat-label">Promedio por Nota</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Gráficos Interactivos -->
    {% if config.get('reportes', {}).get('graficos_interactivos', True) %}
    <div class="row mb-4">
        <div class="col-md-8">
            <div class="neo-card">
                <h5 class="mb-3">
                    <i class="fas fa-chart-line me-2"></i>
                    Tendencia de Ventas (Últimos 12 Meses)
                </h5>
                <canvas id="graficoVentas" height="100"></canvas>
            </div>
        </div>
        <div class="col-md-4">
            <div class="neo-card">
                <h5 class="mb-3">
                    <i class="fas fa-chart-pie me-2"></i>
                    Distribución por Estado
                </h5>
                <canvas id="graficoEstados" height="200"></canvas>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Top Clientes -->
    {% if top_clientes %}
    <div class="row mb-4">
        <div class="col-12">
            <div class="neo-card">
                <h5 class="mb-3">
                    <i class="fas fa-trophy me-2"></i>
                    Top 10 Clientes
                </h5>
                <div class="table-responsive">
                    <table class="table table-sm">
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>Cliente</th>
                                <th>Notas</th>
                                <th>Total USD</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for cliente, datos in top_clientes %}
                            <tr>
                                <td>{{ loop.index }}</td>
                                <td><strong>{{ cliente }}</strong></td>
                                <td><span class="badge bg-info">{{ datos.notas }}</span></td>
                                <td><strong class="text-success">${{ "%.2f"|format(datos.total_usd) }}</strong></td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Tabla de Notas Mejorada -->
    <div class="row">
        <div class="col-12">
            <div class="neo-card">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5 class="mb-0">
                        <i class="fas fa-list me-2"></i>
                        Notas de Entrega ({{ total_notas }})
                    </h5>
                    <div>
                        <button class="btn btn-sm btn-outline-primary" onclick="toggleColumnas()">
                            <i class="fas fa-columns me-1"></i>Columnas
                        </button>
                    </div>
                </div>
                
                {% if notas %}
                <div class="table-responsive">
                    <table class="table table-hover" id="tablaNotas">
                        <thead class="table-dark">
                            <tr>
                                <th class="col-numero">N° Nota</th>
                                <th class="col-fecha">Fecha</th>
                                <th class="col-cliente">Cliente</th>
                                <th class="col-estado">Estado</th>
                                <th class="col-modalidad">Modalidad</th>
                                <th class="col-usd">Total USD</th>
                                <th class="col-bs">Total Bs</th>
                                <th class="col-acciones">Acciones</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for numero, nota in notas.items() %}
                            <tr>
                                <td><strong>{{ nota.numero }}</strong></td>
                                <td>{{ nota.fecha }}</td>
                                <td>
                                    <strong>{{ nota.cliente_nombre or 'Cliente no especificado' }}</strong>
                                    {% if nota.cliente_telefono %}
                                    <br><small class="text-muted">{{ nota.cliente_telefono }}</small>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if nota.estado == 'PENDIENTE_ENTREGA' %}
                                        <span class="badge bg-warning">Pendiente</span>
                                    {% elif nota.estado == 'ENTREGADO' or nota.estado == 'PAGADA' %}
                                        <span class="badge bg-success">Entregado</span>
                                    {% elif nota.estado == 'ANULADO' %}
                                        <span class="badge bg-danger">Anulado</span>
                                    {% else %}
                                        <span class="badge bg-secondary">{{ nota.estado }}</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <span class="badge bg-info">
                                        {{ nota.modalidad_pago.title() if nota.modalidad_pago else 'N/A' }}
                                    </span>
                                </td>
                                <td><strong class="text-success">${{ "%.2f"|format(nota.total_usd) }}</strong></td>
                                <td><strong class="text-primary">Bs {{ "%.2f"|format(nota.total_bs) }}</strong></td>
                                <td>
                                    <div class="btn-group btn-group-sm">
                                        <a href="/notas-entrega/{{ numero }}" class="btn btn-outline-primary" title="Ver">
                                            <i class="fas fa-eye"></i>
                                        </a>
                                        <a href="/notas-entrega/{{ numero }}/imprimir" class="btn btn-outline-success" title="Imprimir">
                                            <i class="fas fa-print"></i>
                                        </a>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="text-center py-5">
                    <i class="fas fa-chart-line fa-3x text-muted mb-3"></i>
                    <h5 class="text-muted">No hay notas de entrega</h5>
                    <p class="text-muted">No se encontraron notas con los filtros seleccionados.</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Chart.js para gráficos -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>

<style>
.neo-stat-card {
    display: flex;
    align-items: center;
    padding: 1.5rem;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border-radius: 12px;
    box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
    transition: transform 0.3s ease;
}

.neo-stat-card:hover {
    transform: translateY(-5px);
}

.stat-icon {
    width: 60px;
    height: 60px;
    background: rgba(255, 255, 255, 0.2);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 24px;
    margin-right: 1rem;
}

.stat-icon.usd {
    background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
}

.stat-icon.bs {
    background: linear-gradient(135deg, #2196F3 0%, #1976D2 100%);
}

.stat-icon.promedio {
    background: linear-gradient(135deg, #FF9800 0%, #F57C00 100%);
}

.stat-content {
    flex: 1;
}

.stat-number {
    font-size: 2rem;
    font-weight: 700;
    margin: 0;
    line-height: 1;
}

.stat-label {
    font-size: 0.9rem;
    opacity: 0.9;
    margin: 0;
    margin-top: 0.5rem;
}

.stat-variacion {
    display: block;
    font-size: 0.8rem;
    margin-top: 0.5rem;
    font-weight: 600;
}

.table th {
    background: linear-gradient(135deg, #004AAD 0%, #00897B 100%);
    color: white;
    font-weight: 600;
    border: none;
    position: sticky;
    top: 0;
    z-index: 10;
}

.table td {
    vertical-align: middle;
    border-color: #e0e0e0;
}

.table-hover tbody tr:hover {
    background-color: #f8f9fa;
    cursor: pointer;
}
</style>

<script>
// Gráfico de Ventas por Mes
const ctxVentas = document.getElementById('graficoVentas');
if (ctxVentas) {
    const datosVentas = {{ notas_por_mes|tojson }};
    const meses = Object.keys(datosVentas).reverse();
    const valores = meses.map(m => datosVentas[m].total_usd);
    
    new Chart(ctxVentas, {
        type: 'line',
        data: {
            labels: meses,
            datasets: [{
                label: 'Ventas USD',
                data: valores,
                borderColor: 'rgb(75, 192, 192)',
                backgroundColor: 'rgba(75, 192, 192, 0.2)',
                tension: 0.4,
                fill: true
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
                legend: {
                    display: true
                }
            },
            scales: {
                y: {
                    beginAtZero: true
                }
            }
        }
    });
}

// Gráfico de Estados
const ctxEstados = document.getElementById('graficoEstados');
if (ctxEstados) {
    const datosEstados = {{ notas_por_estado|tojson }};
    const estados = Object.keys(datosEstados);
    const cantidades = estados.map(e => datosEstados[e].cantidad);
    const colores = ['#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF', '#FF9F40'];
    
    new Chart(ctxEstados, {
        type: 'doughnut',
        data: {
            labels: estados,
            datasets: [{
                data: cantidades,
                backgroundColor: colores.slice(0, estados.length)
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
                legend: {
                    position: 'bottom'
                }
            }
        }
    });
}

// Exportar reporte
function exportarReporte(formato) {
    const form = document.getElementById('formFiltros');
    const formData = new FormData(form);
    const params = new URLSearchParams();
    
    for (const [key, value] of formData.entries()) {
        if (value) params.append(key, value);
    }
    
    const url = `/notas-entrega/reporte/exportar/${formato}?${params.toString()}`;
    window.open(url, '_blank');
}

// Imprimir PDF
function imprimirReporte() {
    const form = document.getElementById('formFiltros');
    const formData = new FormData(form);
    const params = new URLSearchParams();
    
    for (const [key, value] of formData.entries()) {
        if (value) params.append(key, value);
    }
    
    const url = `/notas-entrega/reporte/imprimir?${params.toString()}`;
    window.open(url, '_blank');
}

// Toggle comparación
document.getElementById('comparar')?.addEventListener('change', function() {
    const div = document.getElementById('periodoComparacion');
    if (this.checked) {
        div.style.display = 'block';
    } else {
        div.style.display = 'none';
    }
});

// Toggle columnas (funcionalidad básica)
function toggleColumnas() {
    alert('Funcionalidad de personalización de columnas - Próximamente');
}
</script>
{% endblock %}
