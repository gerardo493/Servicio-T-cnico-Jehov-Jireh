{% extends "base.html" %}

{% block title %}Cuentas por Cobrar - Sistema Moderno{% endblock %}

{% block extra_head %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
{% endblock %}

{% block content %}
<style>
    /* Estilo Neom√≥rfico Moderno para Cuentas por Cobrar */
    .cuentas-container {
        background: linear-gradient(135deg, #f0f0f3 0%, #e6e6e9 100%);
        min-height: 100vh;
        padding: 2rem 0;
    }

    .neo-card {
        background: #f0f0f3;
        border-radius: 25px;
        padding: 2rem;
        margin-bottom: 2rem;
        box-shadow: 
            20px 20px 60px #d1d9e6,
            -20px -20px 60px #ffffff;
        border: 1px solid rgba(255, 255, 255, 0.2);
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .neo-card:hover {
        box-shadow: 
            25px 25px 70px #d1d9e6,
            -25px -25px 70px #ffffff;
        transform: translateY(-2px);
    }

    .neo-header {
        background: linear-gradient(135deg, #e8e8e8 0%, #d1d1d1 100%);
        border-radius: 25px;
        padding: 2.5rem;
        margin-bottom: 2rem;
        box-shadow: 
            20px 20px 60px #c4c4c4,
            -20px -20px 60px #ffffff,
            inset 2px 2px 4px rgba(255, 255, 255, 0.7),
            inset -2px -2px 4px rgba(0, 0, 0, 0.1);
        color: #2d3748;
        position: relative;
        overflow: hidden;
        border: 1px solid rgba(255, 255, 255, 0.2);
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .neo-header:hover {
        box-shadow: 
            25px 25px 70px #c4c4c4,
            -25px -25px 70px #ffffff,
            inset 3px 3px 6px rgba(255, 255, 255, 0.8),
            inset -3px -3px 6px rgba(0, 0, 0, 0.15);
        transform: translateY(-2px);
    }

    .neo-header::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><pattern id="grain" width="100" height="100" patternUnits="userSpaceOnUse"><circle cx="25" cy="25" r="1" fill="white" opacity="0.1"/><circle cx="75" cy="75" r="1" fill="white" opacity="0.1"/></pattern></defs><rect width="100" height="100" fill="url(%23grain)"/></svg>');
        opacity: 0.3;
    }

    .neo-title {
        font-size: 2.5rem;
        font-weight: 800;
        margin-bottom: 0.5rem;
        position: relative;
        z-index: 1;
        color: #1a202c;
        text-shadow: 
            0 2px 4px rgba(0, 0, 0, 0.1),
            0 0 20px rgba(0, 255, 136, 0.3);
        background: linear-gradient(135deg, #1a202c 0%, #2d3748 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
    }

    .neo-subtitle {
        font-size: 1.1rem;
        font-weight: 600;
        position: relative;
        z-index: 1;
        color: #4a5568;
        text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
        background: linear-gradient(135deg, #4a5568 0%, #718096 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
    }

    .neo-header .fas {
        font-size: 2rem;
        color: #00ff88;
        text-shadow: 0 0 15px rgba(0, 255, 136, 0.6);
        filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.1));
    }

    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 1.5rem;
        margin-bottom: 2rem;
    }

    .stat-card {
        background: #f0f0f3;
        border-radius: 20px;
        padding: 1.5rem;
        text-align: center;
        box-shadow: 
            15px 15px 30px #d1d9e6,
            -15px -15px 30px #ffffff;
        transition: all 0.3s ease;
        border: 1px solid rgba(255, 255, 255, 0.2);
        position: relative;
        overflow: hidden;
    }

    .stat-card:hover {
        transform: translateY(-3px);
        box-shadow: 
            20px 20px 40px #d1d9e6,
            -20px -20px 40px #ffffff;
    }

    .stat-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 4px;
        background: linear-gradient(135deg, #00ff88 0%, #00cc6a 100%);
        box-shadow: 0 0 10px rgba(0, 255, 136, 0.5);
    }

    .stat-icon {
        font-size: 2.5rem;
        margin-bottom: 1rem;
        background: linear-gradient(135deg, #00ff88 0%, #00cc6a 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        text-shadow: 0 0 10px rgba(0, 255, 136, 0.5);
    }

    .stat-number {
        font-size: 2rem;
        font-weight: 700;
        color: #00ff88;
        margin-bottom: 0.5rem;
        text-shadow: 0 0 10px rgba(0, 255, 136, 0.5);
    }

    .stat-label {
        color: #718096;
        font-weight: 500;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        font-size: 0.9rem;
    }

    .stat-trend {
        font-size: 0.8rem;
        margin-top: 0.5rem;
        padding: 0.25rem 0.5rem;
        border-radius: 10px;
        font-weight: 600;
    }

    .trend-up {
        background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        color: white;
    }

    .trend-down {
        background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
        color: white;
    }

    .filters-card {
        background: #f0f0f3;
        border-radius: 20px;
        padding: 1.5rem;
        margin-bottom: 2rem;
        box-shadow: 
            15px 15px 30px #d1d9e6,
            -15px -15px 30px #ffffff;
        border: 1px solid rgba(255, 255, 255, 0.2);
    }

    .neo-input {
        background: #f0f0f3;
        border: none;
        border-radius: 15px;
        padding: 12px 20px;
        box-shadow: 
            inset 6px 6px 12px #d1d9e6,
            inset -6px -6px 12px #ffffff;
        color: #2d3748;
        font-weight: 500;
        transition: all 0.3s ease;
        width: 100%;
    }

    .neo-input:focus {
        outline: none;
        box-shadow: 
            inset 8px 8px 16px #d1d9e6,
            inset -8px -8px 16px #ffffff;
    }

    .neo-select {
        background: #f0f0f3;
        border: none;
        border-radius: 15px;
        padding: 12px 20px;
        box-shadow: 
            inset 6px 6px 12px #d1d9e6,
            inset -6px -6px 12px #ffffff;
        color: #2d3748;
        font-weight: 500;
        transition: all 0.3s ease;
        width: 100%;
        cursor: pointer;
    }

    .neo-select:focus {
        outline: none;
        box-shadow: 
            inset 8px 8px 16px #d1d9e6,
            inset -8px -8px 16px #ffffff;
    }

    .neo-button {
        background: #f0f0f3;
        border: none;
        border-radius: 15px;
        padding: 12px 24px;
        box-shadow: 
            6px 6px 12px #d1d9e6,
            -6px -6px 12px #ffffff;
        color: #4a5568;
        font-weight: 600;
        transition: all 0.3s ease;
        cursor: pointer;
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        text-decoration: none;
    }

    .neo-button:hover {
        box-shadow: 
            8px 8px 16px #d1d9e6,
            -8px -8px 16px #ffffff;
        transform: translateY(-1px);
        text-decoration: none;
        color: #4a5568;
    }

    .neo-button:active {
        box-shadow: 
            inset 4px 4px 8px #d1d9e6,
            inset -4px -4px 8px #ffffff;
        transform: translateY(0);
    }

    .neo-button-primary {
        background: linear-gradient(135deg, #00ff88 0%, #00cc6a 100%);
        color: #000;
        box-shadow: 
            0 0 20px rgba(0, 255, 136, 0.5),
            6px 6px 12px rgba(0, 255, 136, 0.3),
            -6px -6px 12px rgba(0, 204, 106, 0.3);
        border: 1px solid #00ff88;
    }

    .neo-button-primary:hover {
        box-shadow: 
            0 0 30px rgba(0, 255, 136, 0.8),
            8px 8px 16px rgba(0, 255, 136, 0.4),
            -8px -8px 16px rgba(0, 204, 106, 0.4);
        color: #000;
    }

    .neo-button-success {
        background: linear-gradient(135deg, #00ff88 0%, #00cc6a 100%);
        color: #000;
        box-shadow: 
            0 0 20px rgba(0, 255, 136, 0.5),
            6px 6px 12px rgba(0, 255, 136, 0.3),
            -6px -6px 12px rgba(0, 204, 106, 0.3);
        border: 1px solid #00ff88;
    }

    .neo-button-success:hover {
        box-shadow: 
            0 0 30px rgba(0, 255, 136, 0.8),
            8px 8px 16px rgba(0, 255, 136, 0.4),
            -8px -8px 16px rgba(0, 204, 106, 0.4);
        color: #000;
    }

    .neo-button-warning {
        background: linear-gradient(135deg, #00ff88 0%, #00cc6a 100%);
        color: #000;
        box-shadow: 
            0 0 20px rgba(0, 255, 136, 0.5),
            6px 6px 12px rgba(0, 255, 136, 0.3),
            -6px -6px 12px rgba(0, 204, 106, 0.3);
        border: 1px solid #00ff88;
    }

    .neo-button-warning:hover {
        box-shadow: 
            0 0 30px rgba(0, 255, 136, 0.8),
            8px 8px 16px rgba(0, 255, 136, 0.4),
            -8px -8px 16px rgba(0, 204, 106, 0.4);
        color: #000;
    }

    .neo-button-danger {
        background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
        color: white;
        box-shadow: 
            6px 6px 12px rgba(239, 68, 68, 0.3),
            -6px -6px 12px rgba(220, 38, 38, 0.3);
    }

    .neo-button-danger:hover {
        box-shadow: 
            8px 8px 16px rgba(239, 68, 68, 0.4),
            -8px -8px 16px rgba(220, 38, 38, 0.4);
        color: white;
    }

    .cuenta-card {
        background: #f0f0f3;
        border-radius: 20px;
        padding: 1.5rem;
        margin-bottom: 1.5rem;
        box-shadow: 
            15px 15px 30px #d1d9e6,
            -15px -15px 30px #ffffff;
        border: 1px solid rgba(255, 255, 255, 0.2);
        transition: all 0.3s ease;
        position: relative;
        overflow: hidden;
    }

    .cuenta-card:hover {
        transform: translateY(-3px);
        box-shadow: 
            20px 20px 40px #d1d9e6,
            -20px -20px 40px #ffffff;
    }

    .cuenta-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1rem;
        padding-bottom: 1rem;
        border-bottom: 2px solid rgba(255, 255, 255, 0.3);
    }

    .cuenta-numero {
        font-size: 1.5rem;
        font-weight: 700;
        color: #2d3748;
    }

    .cuenta-fecha {
        color: #718096;
        font-weight: 500;
    }

    .cuenta-cliente {
        font-size: 1.2rem;
        font-weight: 600;
        color: #4a5568;
        margin-bottom: 0.5rem;
    }

    .cuenta-details {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1rem;
        margin-bottom: 1rem;
    }

    .detail-item {
        display: flex;
        flex-direction: column;
        gap: 0.25rem;
    }

    .detail-label {
        font-size: 0.9rem;
        color: #718096;
        font-weight: 500;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .detail-value {
        font-size: 1rem;
        color: #2d3748;
        font-weight: 600;
    }

    .status-badge {
        padding: 8px 16px;
        border-radius: 20px;
        font-size: 0.9rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .status-por-cobrar {
        background: linear-gradient(135deg, #00ff88 0%, #00cc6a 100%);
        color: #000;
        box-shadow: 
            0 0 15px rgba(0, 255, 136, 0.5),
            4px 4px 8px rgba(0, 255, 136, 0.3),
            -4px -4px 8px rgba(0, 204, 106, 0.3);
        border: 1px solid #00ff88;
    }

    .status-abonada {
        background: linear-gradient(135deg, #00ff88 0%, #00cc6a 100%);
        color: #000;
        box-shadow: 
            0 0 15px rgba(0, 255, 136, 0.5),
            4px 4px 8px rgba(0, 255, 136, 0.3),
            -4px -4px 8px rgba(0, 204, 106, 0.3);
        border: 1px solid #00ff88;
    }

    .status-cobrada {
        background: linear-gradient(135deg, #00ff88 0%, #00cc6a 100%);
        color: #000;
        box-shadow: 
            0 0 15px rgba(0, 255, 136, 0.5),
            4px 4px 8px rgba(0, 255, 136, 0.3),
            -4px -4px 8px rgba(0, 204, 106, 0.3);
        border: 1px solid #00ff88;
    }

    .status-vencida {
        background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
        color: white;
        box-shadow: 
            4px 4px 8px rgba(239, 68, 68, 0.3),
            -4px -4px 8px rgba(220, 38, 38, 0.3);
    }

    .cuenta-actions {
        display: flex;
        gap: 0.75rem;
        flex-wrap: wrap;
    }

    .action-btn {
        padding: 8px 16px;
        border-radius: 12px;
        font-size: 0.9rem;
        font-weight: 500;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        transition: all 0.3s ease;
    }

    .action-btn-primary {
        background: linear-gradient(135deg, #00ff88 0%, #00cc6a 100%);
        color: #000;
        box-shadow: 
            0 0 15px rgba(0, 255, 136, 0.5),
            4px 4px 8px rgba(0, 255, 136, 0.3),
            -4px -4px 8px rgba(0, 204, 106, 0.3);
        border: 1px solid #00ff88;
    }

    .action-btn-secondary {
        background: #f0f0f3;
        color: #4a5568;
        box-shadow: 
            4px 4px 8px #d1d9e6,
            -4px -4px 8px #ffffff;
    }

    .action-btn:hover {
        transform: translateY(-1px);
        text-decoration: none;
    }

    .chart-container {
        background: #f0f0f3;
        border-radius: 20px;
        padding: 2rem;
        margin-bottom: 2rem;
        box-shadow: 
            15px 15px 30px #d1d9e6,
            -15px -15px 30px #ffffff;
        border: 1px solid rgba(255, 255, 255, 0.2);
    }

    .chart-title {
        font-size: 1.3rem;
        font-weight: 700;
        color: #2d3748;
        margin-bottom: 1.5rem;
        text-align: center;
    }

    .empty-state {
        text-align: center;
        padding: 4rem 2rem;
        color: #718096;
    }

    .empty-state i {
        font-size: 4rem;
        margin-bottom: 1rem;
        color: #cbd5e0;
    }

    .empty-state h3 {
        font-size: 1.5rem;
        margin-bottom: 0.5rem;
        color: #4a5568;
    }

    .empty-state p {
        font-size: 1rem;
        margin-bottom: 2rem;
    }

    .progress-bar {
        width: 100%;
        height: 8px;
        background: #e2e8f0;
        border-radius: 4px;
        overflow: hidden;
        margin-top: 0.5rem;
    }

    .progress-fill {
        height: 100%;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border-radius: 4px;
        transition: width 0.3s ease;
    }

    /* Responsive */
    @media (max-width: 768px) {
        .cuentas-container {
            padding: 1rem 0;
        }
        
        .neo-card {
            padding: 1.5rem;
            margin-bottom: 1rem;
        }
        
        .neo-header {
            padding: 2rem;
        }
        
        .neo-title {
            font-size: 2rem;
        }
        
        .stats-grid {
            grid-template-columns: 1fr;
            gap: 1rem;
        }
        
        .cuenta-details {
            grid-template-columns: 1fr;
        }
        
        .cuenta-actions {
            flex-direction: column;
        }
    }
</style>

<div class="cuentas-container">
    <div class="container-fluid">
        <!-- Header Neom√≥rfico -->
        <div class="neo-header">
            <div class="row align-items-center">
                <div class="col-md-8">
                    <h1 class="neo-title">
                        <i class="fas fa-money-bill-wave me-3"></i>
                        Cuentas por Cobrar
                    </h1>
                    <p class="neo-subtitle">Gesti√≥n completa de cobranzas y pagos pendientes</p>
                </div>
                <div class="col-md-4 text-end">
                    <!-- Bot√≥n eliminado -->
                </div>
            </div>
        </div>

        <!-- Estad√≠sticas -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-icon">
                    <i class="fas fa-exclamation-triangle"></i>
                </div>
                <div class="stat-number">{{ cuentas|length }}</div>
                <div class="stat-label">Total Cuentas</div>
                <div class="stat-trend trend-up">+12% vs mes anterior</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">
                    <i class="fas fa-dollar-sign"></i>
                </div>
                <div class="stat-number">${{ "%.2f"|format(total_por_cobrar_usd) }}</div>
                <div class="stat-label">Por Cobrar USD</div>
                <div class="stat-trend trend-down">-5% vs mes anterior</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">
                    <i class="fas fa-bs"></i>
                </div>
                <div class="stat-number">Bs {{ "%.2f"|format(total_por_cobrar_bs) }}</div>
                <div class="stat-label">Por Cobrar Bs</div>
                <div class="stat-trend trend-up">+8% vs mes anterior</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">
                    <i class="fas fa-clock"></i>
                </div>
                <div class="stat-number">{{ vencidas_count }}</div>
                <div class="stat-label">Vencidas</div>
                <div class="stat-trend trend-down">-15% vs mes anterior</div>
            </div>
        </div>

        <!-- Filtros -->
        <div class="filters-card">
            <div class="row g-3">
                <div class="col-md-3">
                    <select class="neo-select" id="filtroEstado">
                        <option value="por_cobrar" {% if filtro == 'por_cobrar' %}selected{% endif %}>Por Cobrar</option>
                        <option value="abonada" {% if filtro == 'abonada' %}selected{% endif %}>Abonadas</option>
                        <option value="cobrada" {% if filtro == 'cobrada' %}selected{% endif %}>Cobradas</option>
                        <option value="todas">Todas</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <select class="neo-select" id="filtroCliente">
                        <option value="">Todos los clientes</option>
                        {% for cliente in clientes_disponibles %}
                        <option value="{{ cliente.id }}" {% if cliente_seleccionado == cliente.id %}selected{% endif %}>
                            {{ cliente.nombre }}
                        </option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-2">
                    <select class="neo-select" id="filtroMes">
                        <option value="">Todos los meses</option>
                        {% for mes in range(1, 13) %}
                        <option value="{{ mes }}" {% if mes_seleccionado == mes %}selected{% endif %}>
                            {{ ['Ene', 'Feb', 'Mar', 'Abr', 'May', 'Jun', 'Jul', 'Ago', 'Sep', 'Oct', 'Nov', 'Dic'][mes-1] }}
                        </option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-2">
                    <select class="neo-select" id="filtroAnio">
                        <option value="">Todos los a√±os</option>
                        {% for anio in anios_disponibles %}
                        <option value="{{ anio }}" {% if anio_seleccionado == anio %}selected{% endif %}>
                            {{ anio }}
                        </option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-2">
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="soloVencidas" {% if solo_vencidas %}checked{% endif %}>
                        <label class="form-check-label" for="soloVencidas">
                            Solo Vencidas
                        </label>
                    </div>
                </div>
            </div>
            <div class="row mt-3">
                <div class="col-12">
                    <button class="neo-button" id="limpiarFiltros">
                        <i class="fas fa-times me-2"></i>
                        Limpiar Filtros
                    </button>
                    <button class="neo-button neo-button-primary" id="exportarReporte">
                        <i class="fas fa-download me-2"></i>
                        Exportar Reporte
                    </button>
                    <button class="neo-button neo-button-warning" id="enviarRecordatorios">
                        <i class="fas fa-bell me-2"></i>
                        Enviar Recordatorios
                    </button>
                </div>
            </div>
        </div>

        <!-- Gr√°ficos -->
        <div class="row">
            <div class="col-md-6">
                <div class="chart-container">
                    <h3 class="chart-title">Distribuci√≥n por Estado</h3>
                    <canvas id="estadoChart" width="400" height="200"></canvas>
                </div>
            </div>
            <div class="col-md-6">
                <div class="chart-container">
                    <h3 class="chart-title">Antig√ºedad de Cuentas</h3>
                    <canvas id="antiguedadChart" width="400" height="200"></canvas>
                </div>
            </div>
        </div>

        <!-- Lista de Cuentas -->
        {% if cuentas %}
            <div class="row" id="cuentasList">
                {% for cuenta_id, cuenta in cuentas.items() %}
                <div class="col-lg-6 col-xl-4 cuenta-item" 
                     data-estado="{{ cuenta.estado }}" 
                     data-cliente="{{ cuenta.cliente_nombre|lower }}"
                     data-fecha="{{ cuenta.fecha }}"
                     data-vencida="{{ 'true' if cuenta.dias_vencidos > 0 else 'false' }}">
                    <div class="cuenta-card">
                        <div class="cuenta-header">
                            <div>
                                <div class="cuenta-numero">{{ cuenta.numero }}</div>
                                <div class="cuenta-fecha">{{ cuenta.fecha }}</div>
                            </div>
                            <div class="status-badge status-{{ cuenta.estado|replace('_', '-') }}">
                                {% if cuenta.dias_vencidos > 0 %}
                                    Vencida
                                {% else %}
                                    {{ cuenta.estado|replace('_', ' ')|title }}
                                {% endif %}
                            </div>
                        </div>

                        <div class="cuenta-cliente">
                            <i class="fas fa-user me-2"></i>
                            {{ cuenta.cliente_nombre }}
                        </div>

                        <div class="cuenta-details">
                            <div class="detail-item">
                                <div class="detail-label">Total USD</div>
                                <div class="detail-value">${{ "%.2f"|format(cuenta.total_usd) }}</div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-label">Abonado USD</div>
                                <div class="detail-value">${{ "%.2f"|format(cuenta.abonado_usd) }}</div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-label">Saldo Pendiente</div>
                                <div class="detail-value">${{ "%.2f"|format(cuenta.saldo_pendiente) }}</div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-label">D√≠as Vencidos</div>
                                <div class="detail-value">{{ cuenta.dias_vencidos if cuenta.dias_vencidos > 0 else 'Al d√≠a' }}</div>
                            </div>
                        </div>

                        {% if cuenta.estado != 'cobrada' %}
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: {{ (cuenta.abonado_usd / cuenta.total_usd * 100) if cuenta.total_usd > 0 else 0 }}%"></div>
                        </div>
                        <div class="text-center mt-2">
                            <small class="text-muted">
                                {{ "%.1f"|format((cuenta.abonado_usd / cuenta.total_usd * 100) if cuenta.total_usd > 0 else 0) }}% Pagado
                            </small>
                        </div>
                        {% endif %}

                        <div class="cuenta-actions">
                            <a href="/notas-entrega/{{ cuenta.numero }}" class="action-btn action-btn-primary">
                                <i class="fas fa-eye"></i>
                                Ver Nota
                            </a>
                            {% if cuenta.estado != 'cobrada' %}
                            <a href="#" class="action-btn action-btn-success" onclick="alert('Funcionalidad en desarrollo')">
                                <i class="fas fa-credit-card"></i>
                                Registrar Pago
                            </a>
                            <a href="#" class="action-btn action-btn-warning" onclick="enviarRecordatorio('{{ cuenta.numero }}')">
                                <i class="fas fa-bell"></i>
                                Recordatorio
                            </a>
                            {% endif %}
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        {% else %}
            <div class="neo-card">
                <div class="empty-state">
                    <i class="fas fa-money-bill-wave"></i>
                    <h3>No hay cuentas por cobrar</h3>
                    <p>No se encontraron cuentas que coincidan con los filtros seleccionados</p>
                    <button class="neo-button neo-button-primary" id="limpiarFiltros">
                        <i class="fas fa-refresh me-2"></i>
                        Limpiar Filtros
                    </button>
                </div>
            </div>
        {% endif %}
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    console.log('Cuentas por Cobrar Modernas cargadas');
    
    // Datos para gr√°ficos
    const estadoData = {
        'por_cobrar': {{ cuentas.values() | selectattr('estado', 'equalto', 'por_cobrar') | list | length }},
        'abonada': {{ cuentas.values() | selectattr('estado', 'equalto', 'abonada') | list | length }},
        'cobrada': {{ cuentas.values() | selectattr('estado', 'equalto', 'cobrada') | list | length }}
    };
    
    const antiguedadData = {
        '0-30': {{ buckets['0-30'] }},
        '31-60': {{ buckets['31-60'] }},
        '61-90': {{ buckets['61-90'] }},
        '90+': {{ buckets['90+'] }}
    };
    
    // Gr√°fico de distribuci√≥n por estado
    const estadoCtx = document.getElementById('estadoChart').getContext('2d');
    new Chart(estadoCtx, {
        type: 'doughnut',
        data: {
            labels: ['Por Cobrar', 'Abonadas', 'Cobradas'],
            datasets: [{
                data: [estadoData.por_cobrar, estadoData.abonada, estadoData.cobrada],
                backgroundColor: [
                    'rgba(251, 191, 36, 0.8)',
                    'rgba(59, 130, 246, 0.8)',
                    'rgba(16, 185, 129, 0.8)'
                ],
                borderColor: [
                    'rgba(251, 191, 36, 1)',
                    'rgba(59, 130, 246, 1)',
                    'rgba(16, 185, 129, 1)'
                ],
                borderWidth: 2
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom'
                }
            }
        }
    });
    
    // Gr√°fico de antig√ºedad
    const antiguedadCtx = document.getElementById('antiguedadChart').getContext('2d');
    new Chart(antiguedadCtx, {
        type: 'bar',
        data: {
            labels: ['0-30 d√≠as', '31-60 d√≠as', '61-90 d√≠as', '90+ d√≠as'],
            datasets: [{
                label: 'Monto USD',
                data: [antiguedadData['0-30'], antiguedadData['31-60'], antiguedadData['61-90'], antiguedadData['90+']],
                backgroundColor: [
                    'rgba(16, 185, 129, 0.8)',
                    'rgba(59, 130, 246, 0.8)',
                    'rgba(251, 191, 36, 0.8)',
                    'rgba(239, 68, 68, 0.8)'
                ],
                borderColor: [
                    'rgba(16, 185, 129, 1)',
                    'rgba(59, 130, 246, 1)',
                    'rgba(251, 191, 36, 1)',
                    'rgba(239, 68, 68, 1)'
                ],
                borderWidth: 2
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true
                }
            }
        }
    });
    
    // Funcionalidad de filtros
    const filtroEstado = document.getElementById('filtroEstado');
    const filtroCliente = document.getElementById('filtroCliente');
    const filtroMes = document.getElementById('filtroMes');
    const filtroAnio = document.getElementById('filtroAnio');
    const soloVencidas = document.getElementById('soloVencidas');
    const limpiarFiltros = document.getElementById('limpiarFiltros');
    
    function aplicarFiltros() {
        const estado = filtroEstado.value;
        const cliente = filtroCliente.value;
        const mes = filtroMes.value;
        const anio = filtroAnio.value;
        const vencidas = soloVencidas.checked;
        
        const cuentas = document.querySelectorAll('.cuenta-item');
        
        cuentas.forEach(cuenta => {
            let mostrar = true;
            
            // Filtro por estado
            if (estado && estado !== 'todas' && !cuenta.dataset.estado.includes(estado)) {
                mostrar = false;
            }
            
            // Filtro por cliente
            if (cliente && !cuenta.dataset.cliente.includes(cliente.toLowerCase())) {
                mostrar = false;
            }
            
            // Filtro por mes/a√±o
            if (mes || anio) {
                const fecha = cuenta.dataset.fecha;
                if (fecha) {
                    const [y, m] = fecha.split('-');
                    if (anio && y !== anio) mostrar = false;
                    if (mes && m !== mes.padStart(2, '0')) mostrar = false;
                } else {
                    mostrar = false;
                }
            }
            
            // Filtro por vencidas
            if (vencidas && cuenta.dataset.vencida !== 'true') {
                mostrar = false;
            }
            
            cuenta.style.display = mostrar ? 'block' : 'none';
        });
    }
    
    // Event listeners
    filtroEstado.addEventListener('change', aplicarFiltros);
    filtroCliente.addEventListener('change', aplicarFiltros);
    filtroMes.addEventListener('change', aplicarFiltros);
    filtroAnio.addEventListener('change', aplicarFiltros);
    soloVencidas.addEventListener('change', aplicarFiltros);
    
    limpiarFiltros.addEventListener('click', function() {
        filtroEstado.value = 'por_cobrar';
        filtroCliente.value = '';
        filtroMes.value = '';
        filtroAnio.value = '';
        soloVencidas.checked = false;
        aplicarFiltros();
    });
    
    // Exportar reporte
    document.getElementById('exportarReporte').addEventListener('click', function() {
        console.log('Exportar reporte');
        // Implementar exportaci√≥n
    });
    
    // Enviar recordatorios
    document.getElementById('enviarRecordatorios').addEventListener('click', function() {
        console.log('Enviar recordatorios');
        // Implementar env√≠o de recordatorios
    });
    
    // Animaciones de entrada
    const cards = document.querySelectorAll('.cuenta-card');
    cards.forEach((card, index) => {
        card.style.animationDelay = `${index * 0.1}s`;
    });
});

// Funci√≥n para enviar recordatorios
function enviarRecordatorio(notaId) {
    if (confirm('¬øDesea enviar un recordatorio por WhatsApp para esta cuenta?')) {
        fetch('/cuentas-por-cobrar/enviar_recordatorio_whatsapp', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                cliente_id: notaId
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('Recordatorio enviado exitosamente');
            } else {
                alert('Error al enviar recordatorio: ' + (data.error || 'Error desconocido'));
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error al enviar recordatorio');
        });
    }
}
</script>
{% endblock %}
